<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudentsMart - College Marketplace</title>
    <!-- Add modern dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --accent-color: #60a5fa;
            --success-color: #22c55e;
            --error-color: #ef4444;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --background-light: #f3f4f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            color: var(--text-dark);
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
        }

        .hero-section {
            background: linear-gradient(rgba(37,99,235,0.9), rgba(59,130,246,0.9));
            background-image: ('/static/images/hero-bg.jpg');
            background-size: cover;
            color: white;
            padding: 4rem 0;
            margin-bottom: 2rem;
        }

        .auth-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-control, .form-select {
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid #e5e7eb;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(96,165,250,0.2);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .listing-card {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%;
        }

        .listing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .listing-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .listing-content {
            padding: 1.5rem;
        }

        .price-tag {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .search-section {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .modal-content {
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 600;
        }

        .skeleton-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .hero-section {
                padding: 2rem 0;
            }
            
            .auth-card {
                margin: 1rem;
            }
        }
        /* Add these to your existing style section */
        .hero-section {
            background: linear-gradient(rgba(211, 213, 216, 0.9), rgba(59,130,246,0.9));
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding: 4rem 0;
        }

        .choice-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 2rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .choice-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .choice-card h3 {
            margin: 1rem 0;
        }

        .choice-card p {
            opacity: 0.9;
        }
        .admin-dashboard .card {
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .admin-dashboard .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .admin-dashboard .list-group-item {
            border-left: none;
            border-right: none;
        }
        
        .admin-dashboard .list-group-item:first-child {
            border-top: none;
        }
        
        .admin-dashboard .list-group-item:last-child {
            border-bottom: none;
        }
        /* WhatsApp-style Chat Interface */
        /* WhatsApp-style Chat Interface */
        .chat-container {
            height: 80vh;
            overflow: hidden;
        }

        .chat-sidebar {
            border-right: 1px solid #e0e0e0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-sidebar-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-list {
            overflow-y: auto;
            flex-grow: 1;
        }

        .chat-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chat-item:hover {
            background-color: #f5f5f5;
        }

        .chat-window {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #e5ddd5;
        }

        .message {
            max-width: 65%;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 7.5px;
            position: relative;
        }

        .message.sent {
            background-color: #dcf8c6;
            margin-left: auto;
            border-top-right-radius: 0;
        }

        .message.received {
            background-color: white;
            margin-right: auto;
            border-top-left-radius: 0;
        }

        .message-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }

        .chat-input {
            padding: 15px;
            background-color: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .user-avatar img {
            width: 40px;
            height: 40px;
            object-fit: cover;
        }

        .search-box {
            padding: 10px;
            background-color: white;
        }

        .search-box input {
            background-color: #f0f0f0;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
        }
        .message {
            max-width: 65%;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.sent {
            background-color: #dcf8c6;
            margin-left: auto;
            margin-right: 10px;
            border-top-right-radius: 0;
        }
        
        .message.received {
            background-color: white;
            margin-right: auto;
            margin-left: 10px;
            border-top-left-radius: 0;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 5px;
            text-align: right;
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #e5ddd5;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #e5ddd5;
            display: flex;
            flex-direction: column;
            height: calc(80vh - 130px); /* Adjust height to prevent overflow */
            scroll-behavior: smooth;
        }
        
        .message-container {
            display: flex;
            flex-direction: column;
            min-height: min-content;
        }
        
        .chat-input {
            padding: 15px;
            background-color: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            position: sticky;
            bottom: 0;
            z-index: 1;
        }
        
        /* Add smooth scrolling to the chat container */
        .chat-container {
            height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        /* Additional Chat Styles */
        .chat-empty-state {
            text-align: center;
            color: #6c757d;
            padding: 2rem;
        }

        .chat-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .empty-chat-list {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .chat-actions button {
            width: 32px;
            height: 32px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-sidebar-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .search-box .input-group {
            background-color: #fff;
            border-radius: 20px;
            overflow: hidden;
        }

        .search-box input:focus {
            box-shadow: none;
        }

        .chat-list {
            height: calc(80vh - 140px);
            overflow-y: auto;
        }

        .chat-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-item:hover {
            background-color: #f8f9fa;
        }

        .chat-item.active {
            background-color: #e9ecef;
        }

        .message {
            max-width: 75%;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
        }

        .message.sent {
            background-color: #dcf8c6;
            margin-left: auto;
            margin-right: 10px;
            border-top-right-radius: 4px;
        }

        .message.received {
            background-color: white;
            margin-right: auto;
            margin-left: 10px;
            border-top-left-radius: 4px;
        }

        .message-time {
            font-size: 0.7rem;
            color: #999;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }

        .online-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .online-status::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #22c55e;
            border-radius: 50%;
        }

        #messageInput {
            border-radius: 20px;
            padding-left: 1rem;
            padding-right: 1rem;
            border: 1px solid #e0e0e0;
        }

        #messageInput:focus {
            box-shadow: none;
            border-color: #3b82f6;
        }

        #sendMessage {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }

        #sendMessage:disabled {
            background-color: #e0e0e0;
            border-color: #e0e0e0;
        }

        .user-avatar {
            position: relative;
        }

        .user-avatar img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }
        /* Update modal size */
        .modal-dialog.modal-lg {
            max-width: 90vw; /* Makes modal wider */
            height: 90vh; /* Makes modal taller */
            margin: 5vh auto; /* Centers the modal with equal margins */
        }

        .chat-container {
            height: 90vh; /* Makes the container taller */
        }

        .chat-list {
            height: calc(90vh - 140px); /* Adjust chat list height */
        }

        .chat-messages {
            height: calc(90vh - 180px); /* Adjust messages container height */
        }

        /* Ensure the chat window fills the available space */
        .chat-window {
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .chat-empty-state {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1;
        }
        
        .chat-content {
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 2;
        }
        
        .chat-window {
            position: relative;
            height: 90vh;
            overflow: hidden;
        }

        /* Update the chat content styles */
        .chat-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        /* Modal and Container Styles */
        .modal-dialog.modal-lg {
            max-width: 90vw;
            height: 90vh;
            margin: 5vh auto;
        }

        .chat-container {
            height: 90vh;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .chat-sidebar {
            border-right: 1px solid #e0e0e0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chat-sidebar-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .chat-list {
            height: calc(90vh - 140px);
            overflow-y: auto;
        }

        .chat-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-item:hover {
            background-color: #f8f9fa;
        }

        .chat-item.active {
            background-color: #e9ecef;
        }

        /* Search Box Styles */
        .search-box {
            padding: 10px;
            background-color: white;
        }

        .search-box .input-group {
            background-color: #f0f0f0;
            border-radius: 20px;
            overflow: hidden;
        }

        .search-box input {
            border: none;
            background-color: transparent;
        }

        .search-box input:focus {
            box-shadow: none;
            background-color: transparent;
        }

        /* Chat Window Styles */
        .chat-window {
            height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .chat-empty-state {
            text-align: center;
            color: #6c757d;
            padding: 2rem;
        }

        .chat-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            padding: 10px;
        }

        /* Messages Container Styles */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #e5ddd5;
            height: calc(90vh - 140px);
        }

        .message-container {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Message Styles */
        .message {
            max-width: 75%;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
        }

        .message.sent {
            background-color: #dcf8c6;
            margin-left: auto;
            margin-right: 10px;
            border-top-right-radius: 4px;
        }

        .message.received {
            background-color: white;
            margin-right: auto;
            margin-left: 10px;
            border-top-left-radius: 4px;
        }

        .message-time {
            font-size: 0.7rem;
            color: #999;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }

        /* Chat Input Styles */
        .chat-input {
            padding: 15px;
            background-color: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            position: sticky;
            bottom: 0;
        }

        #messageInput {
            border-radius: 20px;
            padding-left: 1rem;
            padding-right: 1rem;
            border: 1px solid #e0e0e0;
        }

        #messageInput:focus {
            box-shadow: none;
            border-color: #3b82f6;
        }

        #sendMessage {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }

        #sendMessage:disabled {
            background-color: #e0e0e0;
            border-color: #e0e0e0;
        }

        /* User Avatar Styles */
        .user-avatar {
            position: relative;
        }

        .user-avatar img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Online Status Styles */
        .online-status {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .online-status::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #22c55e;
            border-radius: 50%;
        }

        /* Scroll Button Styles */
        #scrollBottom {
            width: 40px;
            height: 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: opacity 0.3s;
            position: absolute;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            display: none;
        }

        #scrollBottom:hover {
            opacity: 0.8;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .modal-dialog.modal-lg {
                max-width: 100vw;
                margin: 0;
                height: 100vh;
            }

            .chat-container {
                height: 100vh;
            }

            .chat-messages {
                height: calc(100vh - 140px);
            }

            .chat-list {
                height: calc(100vh - 140px);
            }
        }

        /* Report Modal Styles */
        .report-modal .modal-content {
            border-radius: 15px;
            position: relative;
            z-index: 1050;
        }

        .report-modal .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .report-modal .modal-body {
            position: relative;
            z-index: 1051;
        }

        .report-form {
            padding: 1rem;
            position: relative;
            z-index: 1052;
        }

        .report-form textarea.form-control {
            position: relative;
            z-index: 1053;
            background: #fff;
            pointer-events: auto !important;
            resize: vertical;
            min-height: 100px;
        }

        .report-preview-image {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-top: 1rem;
        }
        /* Footer Styles */
        footer {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
        }

        footer a {
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: var(--accent-color) !important;
            text-decoration: underline !important;
        }

        footer .social-icons a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        footer .social-icons a:hover {
            background-color: var(--primary-color);
            transform: translateY(-3px);
        }

        /* Modal Team Styles */
        .team-member-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }

        /* Responsive Footer */
        @media (max-width: 768px) {
            footer .col-md-4, 
            footer .col-md-2, 
            footer .col-md-3 {
                margin-bottom: 1.5rem;
            }
            
            footer .text-md-start, 
            footer .text-md-end {
                text-align: center !important;
            }
        }
        /* Soft Copy Badge Styling */
        .position-relative {
            position: relative !important;
        }
        
        .position-absolute {
            position: absolute !important;
        }
        
        .top-0 {
            top: 0 !important;
        }
        
        .start-0 {
            left: 0 !important;
        }
        
        /* Download Button Styling */
        .btn-success {
            background-color: #22c55e !important;
            color: white !important;
            transition: all 0.2s ease;
        }
        
        .btn-success:hover {
            background-color: #16a34a !important;
            transform: translateY(-1px);
        }
        
        /* Listing Card Adjustments */
        .listing-card {
            position: relative;
            overflow: visible !important; /* Changed from overflow: hidden */
        }
        
        .listing-image-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem 1rem 0 0;
        }
        
        /* Badge Styling */
        .badge.bg-info {
            background-color: #3b82f6 !important;
            font-size: 0.8rem;
            padding: 0.5rem 0.8rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Button Container Spacing */
        .d-grid.gap-2 {
            gap: 0.8rem !important;
            margin-top: 1rem;
        }
        
        /* Ensure buttons stay visible */
        .listing-content {
            position: relative;
            z-index: 1;
            background: white;
            border-radius: 0 0 1rem 1rem;
        }
        /* Soft Copy Styles */
        .position-relative { position: relative; }
        .position-absolute { position: absolute; }
        .top-0 { top: 0; }
        .start-0 { left: 0; }

        .listing-image-container {
            overflow: visible;
            border-radius: 12px 12px 0 0;
        }

        /* Download Button */
        .btn-success {
            background-color: #22c55e;
            border-color: #16a34a;
            transition: all 0.2s ease;
        }

        .btn-success:hover {
            background-color: #16a34a;
            transform: translateY(-1px);
        }

        /* Badge Styling */
        .badge.bg-info {
            background-color: #3b82f6 !important;
            font-size: 0.8rem;
            padding: 0.5rem 0.8rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Button Container */
        .d-grid.gap-2 {
            gap: 0.8rem !important;
            margin-top: 1rem;
        }

        /* Ensure content visibility */
        .listing-content {
            position: relative;
            z-index: 1;
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 1.25rem;
        }

        /* Image Styling */
        .listing-image {
            height: 200px;
            object-fit: cover;
            width: 100%;
            border-radius: 12px 12px 0 0;
        }
        /* Add this to your style section */
        .faculty-badge .badge {
            font-size: 0.85rem;
            padding: 0.5rem;
            display: inline-flex;
            align-items: center;
        }

        .faculty-badge .badge i {
            margin-right: 0.25rem;
        }
    </style>
</head>
<body>
    
    <!-- Enhanced Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-graduation-cap me-2"></i>StudentsMart
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">

                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown d-none" id="adminMenu">
                        <a class="nav-link" href="#" onclick="showAdminDashboard()">
                            <i class="fas fa-tools me-2"></i>Admin Dashboard
                        </a>
                    </li>
                    <li class="nav-item d-none" id="reportsMenu">
                        <a class="nav-link" href="#" onclick="showAdminDashboard('reports')">
                            <i class="fas fa-flag me-2"></i>Reports
                            <span class="badge bg-danger" id="navReportsBadge">0</span>
                        </a>
                    </li>
                    <li class="nav-item" id="authButtons">
                        <button class="btn btn-outline-primary me-2" onclick="showLoginModal()">
                            <i class="fas fa-sign-in-alt me-2"></i>Login
                        </button>
                        <button class="btn btn-primary" onclick="showRegisterModal()">
                            <i class="fas fa-user-plus me-2"></i>Register
                        </button>
                    </li>
                    
                    
                    
                    
                    <li class="nav-item dropdown d-none" id="userMenu">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-2"></i><span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showMyListings()">
                                <i class="fas fa-list me-2"></i>My Listings
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="showWishlist()">
                                <i class="fas fa-heart me-2"></i>Wishlist
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="showMessages()">
                                <i class="fas fa-envelope me-2"></i>Messages
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section text-center">
        <div class="container">
            <h1 class="display-4 mb-4">The Fastest Campus Service Provider</h1>
            <p class="lead mb-4">Your one-stop marketplace for college essentials</p>
            <div class="row justify-content-center mt-5">
                <div class="col-md-4">
                    <div class="choice-card" onclick="handlePathSelection('buy')">
                        <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                        <h3>Buy Items</h3>
                        <p>Browse and purchase items from other students</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="choice-card" onclick="handlePathSelection('sell')">
                        <i class="fas fa-store fa-3x mb-3"></i>
                        <h3>Sell/Rent Items</h3>
                        <p>List your items for sale or rent</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="container">
        <div class="search-section">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search items...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="collegeFilter">
                        <option value="">All Colleges</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="electronic">Electronic</option>
                        <option value="books">Books</option>
                        <option value="clothes">Clothes</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="sortFilter">
                        <option value="newest">Newest First</option>
                        <option value="price_low">Price: Low to High</option>
                        <option value="price_high">Price: High to Low</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="row g-4" id="listingsGrid">
            <!-- Listings will be dynamically added here -->
        </div>

        <!-- Loading Skeleton -->
        <div class="row g-4" id="loadingSkeleton" style="display: none;">
            <!-- Skeleton cards will be added here -->
        </div>
    </div>
    <div id="listingsSection" style="display: none;">
        <!-- Your existing search-section and listings grid will go here -->
        <div class="container">
            <div class="search-section">
                <!-- Your existing search section content -->
            </div>
            <div class="row g-4" id="listingsGrid">
                <!-- Listings will be dynamically added here -->
            </div>
        </div>
    </div>
    <div class="modal fade" id="adminLoginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="adminLoginForm">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-lock me-2"></i>Admin Login
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    

    <!-- Search Section -->
    

        <!-- Listings Grid -->
        

    <!-- Modals -->
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Login to StudentsMart</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>Login
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="full_name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control" name="department" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Year</label>
                            <select class="form-select" name="year" required>
                                <option value="">Select Year</option>
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">College</label>
                            <select class="form-select" name="college" id="collegeSelect" required>
                                <option value="">Select Your College</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <!-- Inside your registerModal, just before the register button -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="acceptTerms" required>
                            <label class="form-check-label" for="acceptTerms">
                                I agree to the <a href="#" onclick="showTermsModal()">Terms and Conditions</a> and understand that:
                            </label>
                            <div class="terms-summary mt-2 small">
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check-circle text-primary me-2"></i>My listings must be fair and accurate</li>
                                    <li><i class="fas fa-check-circle text-primary me-2"></i>Violations may result in permanent account suspension</li>
                                    <li><i class="fas fa-check-circle text-primary me-2"></i>I will maintain privacy of other users</li>
                                </ul>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-user-plus me-2"></i>Register
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Listing Modal -->
    <!-- Create Listing Modal -->
<!-- Create Listing Modal -->
    <div class="modal fade" id="createListingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Listing</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createListingForm" enctype="multipart/form-data">
                        <div class="row g-3">
                            <!-- Category Selection -->
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <select class="form-select" name="category" id="listingCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="electronic">Electronic</option>
                                    <option value="books">Books</option>
                                    <option value="clothes">Clothes</option>
                                </select>
                            </div>

                            <!-- Product Type -->
                            <div class="col-md-6">
                                <label class="form-label">Product Type</label>
                                <select class="form-select" name="product_type" id="productType" required>
                                    <option value="">Select Product Type</option>
                                </select>
                            </div>

                            <!-- Title -->
                            <div class="col-12">
                                <label class="form-label">Title</label>
                                <input type="text" class="form-control" name="title" required>
                            </div>
                            <div class="col-md-6 field-branch" style="display: none;">
                                <label class="form-label">Branch</label>
                                <select class="form-select" name="branch">
                                    <option value="">Select Branch</option>
                                    <option value="CSE">CSE</option>
                                    <option value="ECE">ECE</option>
                                    <option value="EEE">EEE</option>
                                    <option value="MECH">MECH</option>
                                    <option value="CIVIL">CIVIL</option>
                                </select>
                            </div>
                            <div class="col-md-6 field-faculty" style="display: none;">
                                <label class="form-label">Faculty Name</label>
                                <input type="text" class="form-control" name="faculty_name" placeholder="Enter faculty name">
                            </div>
                            <div class="col-md-6 field-subject" style="display: none;">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control" name="subject">
                            </div>
                            <!-- Add this to your Create Listing form, near the other property details -->
                            <!-- Add this to your Create Listing form -->
                            <!-- Add this to your Create Listing form, near the other property details -->
                            <div class="col-md-6">
                                <label for="academicYear" class="form-label">Academic Year</label>
                                <select class="form-select" id="academicYear" name="study_year" required>
                                    <option value="" selected disabled>Select Year</option>
                                    <option value="1">1st Year</option>
                                    <option value="2">2nd Year</option>
                                    <option value="3">3rd Year</option>
                                    <option value="4">4th Year</option>
                                    
                                </select>
                            </div>
                            <!-- Add this after the Subject field -->
                            <div class="col-md-6 field-softcopy" style="display: none;">
                                <label class="form-label">Copy Type</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="copy_type" id="softCopy" value="soft" onclick="toggleFileUpload()">
                                    <label class="form-check-label" for="softCopy">Soft Copy</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="copy_type" id="hardCopy" value="hard" checked onclick="toggleFileUpload()">
                                    <label class="form-check-label" for="hardCopy">Hard Copy</label>
                                </div>
                            </div>

                            <div class="col-12 field-fileupload" style="display: none;">
                                <label class="form-label">Upload PDF/Document</label>
                                <input type="file" class="form-control" name="document" accept=".pdf,.doc,.docx">
                            </div>


                            <!-- Description -->
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3" required></textarea>
                            </div>

                            <!-- Listing Type -->
                            <div class="col-md-6">
                                <label class="form-label">Listing Type</label>
                                <select class="form-select" name="listing_type" id="listingType" required onchange="toggleRentFields()">
                                    <option value="sell">Sell</option>
                                    <option value="rent">Rent</option>
                                </select>
                            </div>
                            
                            <!-- Selling Price field -->
                            <div class="col-md-6" id="sellPriceField">
                                <label class="form-label">Selling Price (?)</label>
                                <input type="number" class="form-control" name="price" required>
                            </div>
                            
                            <!-- Rent-related fields -->
                            <div class="col-md-6 rent-field" id="rentPriceField" style="display: none;">
                                <label class="form-label">Rental Price (?)</label>
                                <input type="number" class="form-control" name="rent_price">
                            </div>
                            
                            <div class="col-md-6 rent-field" id="rentTenureField" style="display: none;">
                                <label class="form-label">Rental Tenure (Days)</label>
                                <input type="number" class="form-control" name="rent_tenure" min="1">
                            </div>

                            <!-- Electronic-specific fields -->
                            <div class="col-md-6 field-working-condition" style="display: none;">
                                <label class="form-label">Working Condition</label>
                                <select class="form-select" name="working_condition">
                                    <option value="">Select Condition</option>
                                    <option value="Fully functional">Fully functional</option>
                                    <option value="Needs repair">Needs repair</option>
                                </select>
                            </div>

                            <div class="col-md-6 field-warranty" style="display: none;">
                                <label class="form-label">Warranty Status</label>
                                <select class="form-select" name="warranty_status">
                                    <option value="">Select Warranty Status</option>
                                    <option value="No">No Warranty</option>
                                    <option value="Yes">Under Warranty</option>
                                </select>
                            </div>

                            <!-- Book-specific fields -->
                            

                            

                            <!-- Image Upload -->
                            <div class="col-12">
                                <label class="form-label">Product Image</label>
                                <input type="file" class="form-control" name="image" accept="image/*" required>
                                <div id="imagePreview" class="mt-2" style="display: none;">
                                    <img src="" alt="Preview" style="max-width: 200px; max-height: 200px;">
                                </div>
                            </div>

                            <!-- Warning Checkbox -->
                            <div class="col-12">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" name="is_fake_warning" id="fakeWarning" required>
                                    <label class="form-check-label" for="fakeWarning">
                                        I confirm that this product is genuine and the information provided is accurate
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus-circle me-2"></i>Create Listing
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add this right before the closing </body> tag -->
    <!-- Chat Modal -->
<!-- Chat Modal -->
    <!-- Chat Modal -->
   <!-- Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content chat-container">
                <div class="modal-header border-0 p-0">
                    <button type="button" class="btn-close position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="row g-0 h-100">
                    <!-- Left Sidebar -->
                    <div class="col-4 chat-sidebar">
                        <div class="chat-sidebar-header">
                            <div class="d-flex align-items-center p-3">
                                <div class="user-avatar me-2">
                                    <img src="https://via.placeholder.com/40" class="rounded-circle" alt="Profile" id="currentUserAvatar">
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0" id="currentUserName"></h6>
                                    <small class="text-muted">Your Account</small>
                                </div>
                            </div>
                            <div class="search-box p-2">
                                <div class="input-group">
                                    <span class="input-group-text border-0 bg-light">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 bg-light" 
                                        placeholder="Search conversations" id="chatSearch">
                                </div>
                            </div>
                        </div>
                        <div class="chat-list" id="chatList">
                            <!-- Chat list items will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Right Chat Window -->
                    <div class="col-8 chat-window">
                        <!-- Empty state -->
                        <div class="chat-empty-state h-100 d-flex flex-column justify-content-center align-items-center text-muted">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <h5>Welcome to Messages</h5>
                            <p>Select a conversation to start chatting</p>
                        </div>

                        <!-- Chat content -->
                        <div class="chat-content h-100" id="chatContent" style="display: none;">
                            <div class="chat-header">
                                <div class="d-flex align-items-center p-3">
                                    <div class="user-avatar me-2">
                                        <img src="https://via.placeholder.com/40" 
                                            class="rounded-circle" 
                                            alt="Contact"
                                            id="chatContactAvatar">
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0" id="chatContactName"></h6>
                                        <small class="text-muted">
                                            <span class="online-status">online</span>
                                        </small>
                                    </div>
                                    <button class="btn btn-outline-danger btn-sm" id="reportBtn" onclick="showReportModal()">
                                        <i class="fas fa-flag"></i> Report
                                    </button>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessages">
                                <div class="message-container">
                                    <!-- Messages will be dynamically added here -->
                                </div>
                            </div>
                            <div class="chat-input">
                                <div class="input-group">
                                    <input type="text" 
                                        class="form-control" 
                                        id="messageInput" 
                                        placeholder="Type a message"
                                        disabled
                                        autocomplete="off">
                                    <button class="btn btn-primary" id="sendMessage" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Admin Dashboard Modal -->
   <!-- Enhanced Admin Dashboard Modal -->
  <!-- Admin Dashboard Modal -->
    <!-- Update the Admin Dashboard Modal section in index.html -->
   <!-- Admin Dashboard Modal -->
    <div class="modal fade" id="adminDashboardModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Admin Dashboard</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="container-fluid">
                        <div class="row">
                            <!-- Sidebar -->
                            <div class="col-md-3 col-lg-2 bg-light p-0 border-end">
                                <div class="d-flex flex-column h-100">
                                    <div class="p-3 border-bottom">
                                        <div class="d-flex align-items-center">
                                            <div class="me-2">
                                                <i class="fas fa-user-shield fs-4 text-primary"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">Admin Panel</h6>
                                                <small class="text-muted">Welcome, ${currentUser.full_name}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="nav flex-column nav-pills p-3" id="adminTabs" role="tablist">
                                        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button" role="tab">
                                            <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                                        </button>
                                        <button class="nav-link" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab">
                                            <i class="fas fa-users me-2"></i> Users
                                        </button>
                                        <button class="nav-link" id="listings-tab" data-bs-toggle="pill" data-bs-target="#listings" type="button" role="tab">
                                            <i class="fas fa-list me-2"></i> Listings
                                        </button>
                                        <button class="nav-link" id="reports-tab" data-bs-toggle="pill" data-bs-target="#reports" type="button" role="tab">
                                            <i class="fas fa-flag me-2"></i> Reports
                                            <span class="badge bg-danger ms-2" id="reportsBadge">0</span>
                                        </button>
                                        <button class="nav-link" id="colleges-tab" data-bs-toggle="pill" data-bs-target="#colleges" type="button" role="tab">
                                            <i class="fas fa-university me-2"></i> Colleges
                                        </button>
                                        <button class="nav-link" id="activity-tab" data-bs-toggle="pill" data-bs-target="#activity" type="button" role="tab">
                                            <i class="fas fa-history me-2"></i> Activity Log
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Main Content -->
                            <div class="col-md-9 col-lg-10 p-4">
                                <div class="tab-content">
                                    <!-- Dashboard Tab -->
                                    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                                        <div class="row mb-4">
                                            <div class="col-md-3">
                                                <div class="card bg-primary text-white">
                                                    <div class="card-body">
                                                        <h5 class="card-title">Total Users</h5>
                                                        <h2 id="totalUsers">0</h2>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small>Last 30 days: <span id="newUsers">0</span></small>
                                                            <i class="fas fa-users fs-4"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-success text-white">
                                                    <div class="card-body">
                                                        <h5 class="card-title">Verified Users</h5>
                                                        <h2 id="verifiedUsers">0</h2>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small>Unverified: <span id="unverifiedUsers">0</span></small>
                                                            <i class="fas fa-user-check fs-4"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-info text-white">
                                                    <div class="card-body">
                                                        <h5 class="card-title">Total Listings</h5>
                                                        <h2 id="totalListings">0</h2>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small>Last 30 days: <span id="newListings">0</span></small>
                                                            <i class="fas fa-list-alt fs-4"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="card bg-warning text-dark">
                                                    <div class="card-body">
                                                        <h5 class="card-title">Fake Warnings</h5>
                                                        <h2 id="fakeWarnings">0</h2>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small>Pending: <span id="pendingReports">0</span></small>
                                                            <i class="fas fa-exclamation-triangle fs-4"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header bg-white">
                                                        <h5 class="mb-0">User Growth</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="userGrowthChart" height="250"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header bg-white">
                                                        <h5 class="mb-0">Listing Growth</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="listingGrowthChart" height="250"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header bg-white">
                                                        <h5 class="mb-0">Categories Distribution</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="categoryChart" height="250"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card">
                                                    <div class="card-header bg-white">
                                                        <h5 class="mb-0">Top Colleges</h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="collegeChart" height="250"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Users Tab -->
                                    <div class="tab-pane fade" id="users" role="tabpanel">
                                        <div class="card">
                                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">User Management</h5>
                                                <div class="d-flex gap-2">
                                                    <div class="input-group input-group-sm" style="width: 250px;">
                                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                        <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                                                    </div>
                                                    <select class="form-select form-select-sm" id="userFilter" style="width: 150px;">
                                                        <option value="">All Users</option>
                                                        <option value="verified">Verified</option>
                                                        <option value="unverified">Unverified</option>
                                                        <option value="admin">Admins</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th width="50">
                                                                    <input type="checkbox" class="form-check-input" id="selectAllUsers">
                                                                </th>
                                                                <th>ID</th>
                                                                <th>Name</th>
                                                                <th>Email</th>
                                                                <th>College</th>
                                                                <th>Verified</th>
                                                                <th>Listings</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="usersTableBody">
                                                            <!-- Users will be loaded here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                                <div class="d-flex gap-2">
                                                    <select class="form-select form-select-sm" id="bulkUserAction" style="width: 150px;">
                                                        <option value="">Bulk Actions</option>
                                                        <option value="verify">Verify Selected</option>
                                                        <option value="unverify">Unverify Selected</option>
                                                        <option value="delete">Delete Selected</option>
                                                    </select>
                                                    <button class="btn btn-sm btn-primary" id="applyBulkAction">Apply</button>
                                                </div>
                                                <div class="pagination-info">
                                                    Showing <span id="userStart">1</span> to <span id="userEnd">10</span> of <span id="userTotal">0</span> users
                                                </div>
                                                <div class="d-flex gap-1">
                                                    <button class="btn btn-sm btn-outline-secondary" id="userPrevPage" disabled>
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary" id="userNextPage" disabled>
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Listings Tab -->
                                    <div class="tab-pane fade" id="listings" role="tabpanel">
                                        <div class="card">
                                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">Listing Management</h5>
                                                <div class="d-flex gap-2">
                                                    <div class="input-group input-group-sm" style="width: 250px;">
                                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                        <input type="text" class="form-control" id="listingSearch" placeholder="Search listings...">
                                                    </div>
                                                    <select class="form-select form-select-sm" id="listingFilter" style="width: 150px;">
                                                        <option value="">All Listings</option>
                                                        <option value="fake">Fake Warnings</option>
                                                        <option value="recent">Recent</option>
                                                        <option value="old">Old</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th width="50">
                                                                    <input type="checkbox" class="form-check-input" id="selectAllListings">
                                                                </th>
                                                                <th>ID</th>
                                                                <th>Title</th>
                                                                <th>Price</th>
                                                                <th>Category</th>
                                                                <th>Seller</th>
                                                                <th>Fake Warning</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="listingsTableBody">
                                                            <!-- Listings will be loaded here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                                <div class="d-flex gap-2">
                                                    <select class="form-select form-select-sm" id="bulkListingAction" style="width: 150px;">
                                                        <option value="">Bulk Actions</option>
                                                        <option value="flag">Flag as Fake</option>
                                                        <option value="unflag">Remove Flag</option>
                                                        <option value="delete">Delete</option>
                                                    </select>
                                                    <button class="btn btn-sm btn-primary" id="applyBulkListingAction">Apply</button>
                                                </div>
                                                <div class="pagination-info">
                                                    Showing <span id="listingStart">1</span> to <span id="listingEnd">10</span> of <span id="listingTotal">0</span> listings
                                                </div>
                                                <div class="d-flex gap-1">
                                                    <button class="btn btn-sm btn-outline-secondary" id="listingPrevPage" disabled>
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary" id="listingNextPage" disabled>
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Reports Tab -->
                                    <div class="tab-pane fade" id="reports" role="tabpanel">
                                        <div class="card">
                                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">Reported Content</h5>
                                                <div class="d-flex gap-2">
                                                    <select class="form-select form-select-sm" id="reportFilter" style="width: 150px;">
                                                        <option value="">All Reports</option>
                                                        <option value="pending">Pending</option>
                                                        <option value="resolved">Resolved</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Listing</th>
                                                                <th>Reporter</th>
                                                                <th>Reason</th>
                                                                <th>Status</th>
                                                                <th>Date</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="reportsTableBody">
                                                            <!-- Reports will be loaded here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                                <div class="pagination-info">
                                                    Showing <span id="reportStart">1</span> to <span id="reportEnd">10</span> of <span id="reportTotal">0</span> reports
                                                </div>
                                                <div class="d-flex gap-1">
                                                    <button class="btn btn-sm btn-outline-secondary" id="reportPrevPage" disabled>
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary" id="reportNextPage" disabled>
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Colleges Tab -->
                                    <div class="tab-pane fade" id="colleges" role="tabpanel">
                                        <div class="card">
                                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">College Management</h5>
                                                <div class="d-flex gap-2">
                                                    <div class="input-group input-group-sm" style="width: 250px;">
                                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                        <input type="text" class="form-control" id="collegeSearch" placeholder="Search colleges...">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>College Name</th>
                                                                <th>Users</th>
                                                                <th>Listings</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="collegesTableBody">
                                                            <!-- Colleges will be loaded here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                                <div class="pagination-info">
                                                    Showing <span id="collegeStart">1</span> to <span id="collegeEnd">10</span> of <span id="collegeTotal">0</span> colleges
                                                </div>
                                                <div class="d-flex gap-1">
                                                    <button class="btn btn-sm btn-outline-secondary" id="collegePrevPage" disabled>
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary" id="collegeNextPage" disabled>
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Activity Log Tab -->
                                    <div class="tab-pane fade" id="activity" role="tabpanel">
                                        <div class="card">
                                            <div class="card-header bg-white">
                                                <h5 class="mb-0">Admin Activity Log</h5>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Admin</th>
                                                                <th>Action</th>
                                                                <th>Target</th>
                                                                <th>Date</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="activityTableBody">
                                                            <!-- Activities will be loaded here -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                                                <div class="pagination-info">
                                                    Showing <span id="activityStart">1</span> to <span id="activityEnd">10</span> of <span id="activityTotal">0</span> activities
                                                </div>
                                                <div class="d-flex gap-1">
                                                    <button class="btn btn-sm btn-outline-secondary" id="activityPrevPage" disabled>
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary" id="activityNextPage" disabled>
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="userDetailsContent">
                    <!-- User details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Listing Details Modal -->
    <div class="modal fade" id="listingDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Listing Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="listingDetailsContent">
                    <!-- Listing details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div class="modal fade" id="reportDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reportDetailsContent">
                    <!-- Report details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="resolveReportBtn">Mark as Resolved</button>
                    <button type="button" class="btn btn-primary" id="reviewReportBtn">Mark as Reviewed</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade report-modal" id="reportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report User</h5>
                    <button type="button" class="btn-close" onclick="closeReportModal()"></button>
                </div>
                <div class="modal-body">
                    <form id="reportForm" class="report-form">
                        <input type="hidden" id="reportListingId">
                        <input type="hidden" id="reportMessageThreadId">
                        <div class="mb-3">
                            <label for="reportDescription" class="form-label">Describe why you are reporting this user</label>
                            <textarea class="form-control" id="reportDescription" rows="4" required placeholder="Explain the issue with this user or conversation..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="reportImage" class="form-label">Add supporting image (optional)</label>
                            <input type="file" class="form-control" id="reportImage" accept="image/*">
                            <img id="reportPreviewImage" class="report-preview-image d-none">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Submit Report</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer Section -->
    <footer class="bg-dark text-white pt-5 pb-4">
        <div class="container">
            <div class="row">
                <!-- About Us Column -->
                <div class="col-md-4 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-graduation-cap me-2"></i>StudentsMart
                    </h5>
                    <p>The fastest campus service provider connecting students to buy, sell, and rent college essentials.</p>
                    <button class="btn btn-outline-light btn-sm" onclick="showAboutUs()">
                        <i class="fas fa-info-circle me-1"></i>About Us
                    </button>
                </div>
                
                <!-- Quick Links Column -->
                <div class="col-md-2 mb-4">
                    <h5 class="text-primary mb-3">Quick Links</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none" onclick="handlePathSelection('buy')"><i class="fas fa-shopping-cart me-2"></i>Buy Items</a></li>
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none" onclick="handlePathSelection('sell')"><i class="fas fa-store me-2"></i>Sell/Rent</a></li>
                       
                    </ul>
                </div>
                
                <!-- Help & Support Column -->
                <div class="col-md-3 mb-4">
                    <h5 class="text-primary mb-3">Help & Support</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none" onclick="ShowFAQPageModal()"><i class="fas fa-question-circle me-2"></i>FAQs</a></li>
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none" onclick="showContactModal()"><i class="fas fa-headset me-2"></i>Contact Us</a></li>
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none" onclick="showTermsModal()"><i class="fas fa-file-contract me-2"></i>Terms</a></li>
                        <li class="mb-2"><a href="#" class="text-white text-decoration-none" onclick="showPrivacyModal()"><i class="fas fa-shield-alt me-2"></i>Privacy</a></li>
                    </ul>
                </div>
                
                <!-- Contact Column -->
                <div class="col-md-3 mb-4">
                    <h5 class="text-primary mb-3">Contact Us</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-envelope me-2"></i>stud.studentsmart@gmail.com</li>
                        <li class="mb-2"><i class="fas fa-phone me-2"></i> +91 8500707175</li>
                        <li class="mb-2"><i class="fas fa-map-marker-alt me-2"></i> Andhra Pradesh</li>
                    </ul>
                    <div class="mt-3">
                        <a href="https://www.facebook.com/share/17dR5Zg2n9/?mibextid=qi2Omg" class="text-white me-2"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-white me-2"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.instagram.com/edutrade_official?igsh=bzVwb2Z2b2wxczBl" class="text-white me-2"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-white me-2"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4 bg-secondary">
            <div class="row">
                <div class="col-md-6 text-center text-md-start">
                    <p class="mb-0">&copy; 2025 StudentsMart. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <p class="mb-0">Made with <i class="fas fa-heart text-danger"></i> by Team StudentsMart</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- About Us Modal -->
    <!-- About Us Modal -->
    <!-- About Us Modal -->
    <!-- About Us Modal -->
    <div class="modal fade" id="aboutUsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">About StudentsMart</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <!-- Logo image with proper sizing and fallback -->
                        <div class="logo-container mb-3" style="width: 120px; height: 120px; margin: 0 auto; overflow: hidden; border-radius: 50%;">
                            <img src="" id="eduTradeLogo" class="img-fluid" alt="StudentsMart Logo" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <h3>Our Story</h3>
                        <p class="lead">Connecting students across different colleges through technology and innovation</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body text-center">
                                    <!-- First founder image with proper sizing and fallback -->
                                    <div class="founder-image-container mb-3" style="width: 120px; height: 120px; margin: 0 auto; overflow: hidden; border-radius: 50%;">
                                        <img src="https://i.ibb.co/8L2PJS2L/rctr.jpg" id="ramCharanImage" class="img-fluid" alt="Ram Charan" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <h5>RAM CHARAN TEJA N L</h5>
                                    <p class="text-muted">Tech Lead & Co-Founder</p>
                                    <p>The technical mastermind behind StudentsMart who built the platform from scratch. A computer science student from VEMU college with expertise in Python, AI, and web development.</p>
                                    <div class="mt-3">
                                        <a href="https://www.linkedin.com/in/n-l-ram-charan-teja-ba2b25288/" class="btn btn-sm btn-outline-primary rounded-circle mx-1" title="Connect with me"><i class="fab fa-linkedin-in"></i></a>
                                        <a href="https://github.com/RamCharanTeja-22" class="btn btn-sm btn-outline-primary rounded-circle mx-1" title="Check my repos"><i class="fab fa-github"></i></a>
                                        <a href="tel:+919177415501" class="btn btn-sm btn-outline-primary rounded-circle mx-1" title="Call Ram Charan"><i class="fas fa-phone"></i></a>
                                
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body text-center">
                                    <!-- Second founder image with proper sizing and fallback -->
                                    <div class="founder-image-container mb-3" style="width: 120px; height: 120px; margin: 0 auto; overflow: hidden; border-radius: 50%;">
                                        <img src="https://i.ibb.co/VYzkQbJG/likith.jpg" id="likithImage" class="img-fluid" alt="Likith" style="width: 100%; height: 100%; object-fit: cover;">
                                    </div>
                                    <h5>LIKITH</h5>
                                    <p class="text-muted">Co-Founder</p>
                                    <p>The visionary from Ram Chandra college who identified a student problem and proposed the concept of a college marketplace. His innovative thinking laid the foundation for StudentsMart.</p>
                                    <div class="mt-3">
                                        <a href="https://www.linkedin.com/in/likith-kanigolla-66740a307" class="btn btn-sm btn-outline-primary rounded-circle mx-1" title="Connect with me"><i class="fab fa-linkedin-in"></i></a>
                                        <a href="https://github.com/likithkanigolla" class="btn btn-sm btn-outline-primary rounded-circle mx-1" title="Ckeck my repos"><i class="fab fa-github"></i></a>
                                        <a href="tel:+918179373099" class="btn btn-sm btn-outline-primary rounded-circle mx-1" title="Call Likith"><i class="fas fa-phone"></i></a>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modified Mentorly Section -->
                    <div class="text-center py-4 border-top border-bottom my-4">
                        <!-- Mentorly Logo Container with proper dimensions -->
                        <div class="mentorly-logo-container mb-3" style="max-width: 300px; margin: 0 auto;">
                            <img src="https://i.ibb.co/CXPFhwY/OP.png" class="img-fluid" alt="Mentorly Logo">
                        </div>
                        <!-- Title Below the Image -->
                        <h4 class="text-primary">Studentsmart is proudly backed by Mentorly.</h4>
                    </div>
                    
                    <!-- Mission Section -->
                    <div class="card bg-light mt-4">
                        <div class="card-body">
                            <h5 class="card-title text-center">Our Mission</h5>
                            <p class="card-text">At StudentsMart, we believe in the power of connection. Our platform was born from a student problem identified by Likith from Ram Chandra college, which was then developed into a full-fledged platform by Ram Charan from VEMU college.</p>
                            <p class="card-text fw-bold text-center mt-3">Connecting students. Sharing resources. Building community.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="mailto:contactstudentsmart@gmail.com" class="btn btn-primary">
                        <i class="fas fa-envelope me-2"></i>Contact Us
                    </a>
                </div>
            </div>
        </div>
    </div>
    <!-- Contact Modal -->
    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="contactModalLabel">
                        <i class="fas fa-envelope me-2"></i>Contact Us
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Contact Methods -->
                    <div class="d-flex justify-content-around mb-4">
                        <a href="mailto:contactstudentsmart@gmail.com" class="text-decoration-none text-center">
                            <div class="bg-light p-3 rounded-circle mb-2">
                                <i class="fas fa-envelope fa-2x text-primary"></i>
                            </div>
                            <span class="d-block">Email</span>
                        </a>
                        <a href="tel:+918500707175" class="text-decoration-none text-center">
                            <div class="bg-light p-3 rounded-circle mb-2">
                                <i class="fas fa-phone fa-2x text-primary"></i>
                            </div>
                            <span class="d-block">Call</span>
                        </a>
                        <a href="https://wa.me/918500707175" target="_blank" class="text-decoration-none text-center">
                            <div class="bg-light p-3 rounded-circle mb-2">
                                <i class="fab fa-whatsapp fa-2x text-primary"></i>
                            </div>
                            <span class="d-block">WhatsApp</span>
                        </a>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Contact Form -->
                    <form id="contactForm" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="contactName" class="form-label">Full Name</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                <input type="text" class="form-control" id="contactName" name="name" placeholder="Enter your name" required>
                                <div class="invalid-feedback">
                                    Please provide your name.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contactEmail" class="form-label">Email Address</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-at"></i></span>
                                <input type="email" class="form-control" id="contactEmail" name="email" placeholder="Enter your email" required>
                                <div class="invalid-feedback">
                                    Please provide a valid email address.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contactSubject" class="form-label">Subject</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-heading"></i></span>
                                <input type="text" class="form-control" id="contactSubject" name="subject" placeholder="Enter subject" required>
                                <div class="invalid-feedback">
                                    Please provide a subject.
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="contactMessage" class="form-label">Message</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-comment-alt"></i></span>
                                <textarea class="form-control" id="contactMessage" name="message" rows="4" placeholder="Enter your message" required></textarea>
                                <div class="invalid-feedback">
                                    Please enter your message.
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane me-2"></i>Send Message
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <p class="small text-muted mb-0">We'll get back to you within 24 hours.</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Terms Modal -->
    <!-- Terms of Service Modal -->
    <!-- Terms Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="termsModalLabel">
                        <i class="fas fa-file-contract me-2"></i>StudentsMart Terms of Service
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <!-- Header Section -->
                    <div class="text-center mb-4">
                        <h4>StudentsMart Marketplace Terms</h4>
                        <p class="text-muted">Last Updated: June 2024</p>
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> Violations may result in permanent account suspension
                        </div>
                    </div>

                    <!-- 1. Acceptance of Terms -->
                    <div class="term-section mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-signature me-2 text-primary"></i>1. Acceptance of Terms
                                </h5>
                            </div>
                            <div class="card-body">
                                <p>By using StudentsMart, you agree to these Terms and all applicable laws. If you don't agree, you may not use our services.</p>
                                <div class="alert alert-warning">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Student Responsibility:</strong> You are responsible for all activities under your account.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Marketplace Rules -->
                    <div class="term-section mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-gavel me-2 text-primary"></i>2. Marketplace Rules
                                </h5>
                            </div>
                            <div class="card-body">
                                <h6 class="text-primary"><i class="fas fa-list-check me-2"></i>Listing Requirements</h6>
                                <ul class="fa-ul">
                                    <li><span class="fa-li"><i class="fas fa-check text-success"></i></span>All listings must be accurate and truthful</li>
                                    <li><span class="fa-li"><i class="fas fa-check text-success"></i></span>You must own or have rights to sell the items</li>
                                    <li><span class="fa-li"><i class="fas fa-check text-success"></i></span>Prices must be fair (no price gouging)</li>
                                    <li><span class="fa-li"><i class="fas fa-check text-success"></i></span>Digital content must be legally obtained</li>
                                </ul>

                                <h6 class="text-primary mt-4"><i class="fas fa-ban me-2"></i>Prohibited Actions</h6>
                                <ul class="fa-ul">
                                    <li><span class="fa-li"><i class="fas fa-times text-danger"></i></span>No fake/misleading listings (instant ban)</li>
                                    <li><span class="fa-li"><i class="fas fa-times text-danger"></i></span>No academic dishonesty (selling exams/assignments)</li>
                                    <li><span class="fa-li"><i class="fas fa-times text-danger"></i></span>No harassment or discrimination</li>
                                    <li><span class="fa-li"><i class="fas fa-times text-danger"></i></span>No spam or commercial advertising</li>
                                </ul>

                                <div class="alert alert-danger mt-3">
                                    <i class="fas fa-skull-crossbones me-2"></i>
                                    <strong>Zero Tolerance:</strong> Academic cheating services will result in permanent ban and reporting to your institution.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Privacy & Conduct -->
                    <div class="term-section mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-user-shield me-2 text-primary"></i>3. Privacy & Conduct
                                </h5>
                            </div>
                            <div class="card-body">
                                <h6 class="text-primary"><i class="fas fa-handshake me-2"></i>Community Standards</h6>
                                <ul>
                                    <li>Keep all communications within StudentsMart</li>
                                    <li>Never share personal contact information in listings</li>
                                    <li>Report suspicious activity immediately</li>
                                    <li>Meet in public spaces for exchanges</li>
                                </ul>

                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    <strong>Safety Tip:</strong> Use our messaging system for all communications to stay protected.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Account Termination -->
                    <div class="term-section mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-user-slash me-2 text-primary"></i>4. Account Termination
                                </h5>
                            </div>
                            <div class="card-body">
                                <p>We may suspend or terminate your account immediately if you:</p>
                                <ul class="fa-ul">
                                    <li><span class="fa-li"><i class="fas fa-hammer text-danger"></i></span>Violate these Terms</li>
                                    <li><span class="fa-li"><i class="fas fa-hammer text-danger"></i></span>Harm other users</li>
                                    <li><span class="fa-li"><i class="fas fa-hammer text-danger"></i></span>Attempt to bypass our systems</li>
                                </ul>
                                <p class="mt-3"><strong>Note:</strong> Permanent bans may include device blocking and reporting to your college administration for serious violations.</p>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Dispute Resolution -->
                    <div class="term-section mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fas fa-balance-scale me-2 text-primary"></i>5. Dispute Resolution
                                </h5>
                            </div>
                            <div class="card-body">
                                <h6 class="text-primary"><i class="fas fa-flag me-2"></i>Reporting Issues</h6>
                                <p>If you have a problem with another user:</p>
                                <ol>
                                    <li>Use our <strong>Report</strong> button immediately</li>
                                    <li>Provide evidence (screenshots, etc.)</li>
                                    <li>Our team will investigate within 48 hours</li>
                                </ol>
                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    StudentsMart acts as a platform only - we're not responsible for transactions between users.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Final Acknowledgement -->
                    <div class="alert alert-dark">
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="fas fa-signature fa-2x text-primary"></i>
                            </div>
                            <div>
                                <h5 class="alert-heading">Your Agreement</h5>
                                <p>By using StudentsMart, you confirm that:</p>
                                <ul class="mb-0">
                                    <li>You're currently enrolled at a recognized educational institution</li>
                                    <li>You'll maintain academic integrity</li>
                                    <li>You've read and accept these Terms</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check me-2"></i>I Understand
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <h2 class="mb-3">StudentsMart Privacy Policy</h2>
                        <p class="text-muted mb-4">Last Updated: April, 2025</p>
                        
                        <!-- Table of Contents -->
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h6 class="card-title">Contents</h6>
                                <ul class="list-unstyled">
                                    <li><a href="#information-collected">1. Information We Collect</a></li>
                                    <li><a href="#information-use">2. How We Use Your Information</a></li>
                                    <li><a href="#information-sharing">3. Information Sharing</a></li>
                                    <li><a href="#data-security">4. Data Security</a></li>
                                    <li><a href="#your-choices">5. Your Choices</a></li>
                                    <li><a href="#policy-changes">6. Changes to This Policy</a></li>
                                    <li><a href="#contact-us">7. Contact Us</a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Section 1 -->
                        <section id="information-collected" class="mb-4">
                            <h4 class="border-bottom pb-2 text-primary">1. Information We Collect</h4>
                            <p>We collect personal information you provide when registering, creating listings, or contacting other users. This may include:</p>
                            <ul>
                                <li>Name and email address</li>
                                <li>College or university information</li>
                                <li>Profile picture and bio information</li>
                                <li>Information about items you list for sale or exchange</li>
                                <li>Communication data between you and other users</li>
                                <li>Device and usage information when you access our platform</li>
                            </ul>
                        </section>
                        
                        <!-- Section 2 -->
                        <section id="information-use" class="mb-4">
                            <h4 class="border-bottom pb-2 text-primary">2. How We Use Your Information</h4>
                            <p>We use your information to:</p>
                            <ul>
                                <li>Create and maintain your account</li>
                                <li>Provide and improve our services</li>
                                <li>Facilitate transactions between users</li>
                                <li>Send important notifications and updates</li>
                                <li>Protect against fraudulent or unauthorized activity</li>
                                <li>Personalize your experience on the platform</li>
                            </ul>
                        </section>
                        
                        <!-- Section 3 -->
                        <section id="information-sharing" class="mb-4">
                            <h4 class="border-bottom pb-2 text-primary">3. Information Sharing</h4>
                            <p>We do not sell your personal information. We may share information:</p>
                            <ul>
                                <li>With other users as necessary to facilitate transactions</li>
                                <li>With service providers who help operate our platform</li>
                                <li>When required by law or to protect rights and safety</li>
                                <li>In the event of a business transfer or acquisition</li>
                            </ul>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> Your public profile and listings are visible to other StudentsMart users.
                            </div>
                        </section>
                        
                        <!-- Section 4 -->
                        <section id="data-security" class="mb-4">
                            <h4 class="border-bottom pb-2 text-primary">4. Data Security</h4>
                            <p>We implement appropriate technical and organizational security measures to protect your information, including:</p>
                            <ul>
                                <li>Encryption of sensitive data</li>
                                <li>Regular security assessments</li>
                                <li>Restricted access to personal information</li>
                            </ul>
                            <p>While we strive to protect your information, no method of transmission over the Internet is 100% secure.</p>
                        </section>
                        
                        <!-- Section 5 -->
                        <section id="your-choices" class="mb-4">
                            <h4 class="border-bottom pb-2 text-primary">5. Your Choices</h4>
                            <p>You have several rights regarding your personal information:</p>
                            <ul>
                                <li>Access, update, or correct your account information at any time</li>
                                <li>Request deletion of your account and personal data</li>
                                <li>Opt out of marketing communications</li>
                                <li>Control privacy settings for your profile and listings</li>
                            </ul>
                            <p>To exercise these rights, visit your account settings or contact our support team.</p>
                        </section>
                        
                        <!-- Section 6 -->
                        <section id="policy-changes" class="mb-4">
                            <h4 class="border-bottom pb-2 text-primary">6. Changes to This Policy</h4>
                            <p>We may update this policy periodically to reflect changes in our practices or legal requirements. We will notify you of significant changes through:</p>
                            <ul>
                                <li>Email notification (for registered users)</li>
                                <li>Prominent notice on our website or app</li>
                            </ul>
                            <p>Continued use of the service after changes constitutes acceptance of the modified policy.</p>
                        </section>
                        
                        <!-- Section 7 -->
                        <section id="contact-us">
                            <h4 class="border-bottom pb-2 text-primary">7. Contact Us</h4>
                            <p>If you have questions or concerns about this Privacy Policy or our data practices, please contact us at:</p>
                            <p><strong>Email:</strong> contactstudentsmart@gmail.com</p>
                            <p><strong>Address:</strong> StudentsMart, Inc., 123 Campus Way, College Town, ST 12345</p>
                        </section>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="FAQPageModal" tabindex="-1" aria-labelledby="FAQPageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="FAQPageModalLabel">Frequently Asked Questions</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row">
                            <div class="col-12 text-center">
                                <h2 class="mb-4">Frequently Asked Questions</h2>
                                <p class="lead mb-4">
                                    Find answers to common questions about StudentsMart.
                                </p>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="accordion" id="faqAccordion">
                                    <!-- FAQ Item 1 -->
                                    <div class="accordion-item mb-3 border-0 rounded overflow-hidden">
                                        <h2 class="accordion-header" id="headingOne">
                                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                                                How do I create an account?
                                            </button>
                                        </h2>
                                        <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                Click on the "Register" button in the top right corner and fill out the registration form with your details. 
                                                You'll need to verify your email address to complete the registration.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- FAQ Item 2 -->
                                    <div class="accordion-item mb-3 border-0 rounded overflow-hidden">
                                        <h2 class="accordion-header" id="headingTwo">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                                                Is there a fee for using StudentsMart?
                                            </button>
                                        </h2>
                                        <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                No, StudentsMart is completely free for students to use. We don't charge any fees for listing items or making purchases.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- FAQ Item 3 -->
                                    <div class="accordion-item mb-3 border-0 rounded overflow-hidden">
                                        <h2 class="accordion-header" id="headingThree">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                                                How do I contact a seller?
                                            </button>
                                        </h2>
                                        <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                Click on the "Contact Seller" button on any listing to send a message to the seller. 
                                                You can then continue the conversation in your messages.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- FAQ Item 4 -->
                                    <div class="accordion-item mb-3 border-0 rounded overflow-hidden">
                                        <h2 class="accordion-header" id="headingFour">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour">
                                                What should I do if I encounter a problem?
                                            </button>
                                        </h2>
                                        <div id="collapseFour" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                If you encounter any issues with a seller or listing, please use the "Report" button or contact our support team immediately.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- FAQ Item 5 -->
                                    <div class="accordion-item mb-3 border-0 rounded overflow-hidden">
                                        <h2 class="accordion-header" id="headingFive">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive">
                                                Can I sell items from other colleges?
                                            </button>
                                        </h2>
                                        <div id="collapseFive" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                            <div class="accordion-body">
                                                Currently, StudentsMart is designed for transactions within the same college campus to ensure safety and convenience. 
                                                We may expand this feature in the future.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const yearDropdown = document.getElementById('propertyYear');
            if (yearDropdown) {
                const currentYear = new Date().getFullYear();
                // Add years from current year down to 1900
                for (let year = currentYear; year >= 4; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearDropdown.appendChild(option);
                }
            }
        });
        // Footer-related functions
        function showAboutUs() {
            const aboutModal = new bootstrap.Modal(document.getElementById('aboutUsModal'));
            aboutModal.show();
        }

        function showContactModal() {
            const contactModal = new bootstrap.Modal(document.getElementById('contactModal'));
            contactModal.show();
        }
        function ShowFAQPageModal(){
            const FAQPageModal = new bootstrap.Modal(document.getElementById('FAQPageModal'));
            FAQPageModal.show();

        }

        function showTermsModal() {
            const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
            termsModal.show();
        }

        function showPrivacyModal() {
            const privacyModal = new bootstrap.Modal(document.getElementById('privacyModal'));
            privacyModal.show();
        }

        // Contact form submission
        // Form validation script for contact form
        document.addEventListener('DOMContentLoaded', function() {
            const contactForm = document.getElementById('contactForm');
            
            if (contactForm) {
                // Form submit event handler with validation
                contactForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    // Check form validity using Bootstrap validation
                    if (!this.checkValidity()) {
                        event.stopPropagation();
                        this.classList.add('was-validated');
                        return;
                    }
                    
                    // Get submit button
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    
                    // Disable button and show loading state
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
                    
                    // Get form data
                    const formData = {
                        name: document.getElementById('contactName').value,
                        email: document.getElementById('contactEmail').value,
                        subject: document.getElementById('contactSubject').value,
                        message: document.getElementById('contactMessage').value
                    };
                    
                    // Send email using fetch API to your server endpoint or a service like Formspree
                    fetch('https://formspree.io/f/myzwpvvp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Success:', data);
                        
                        // Show success message
                        Swal.fire({
                            title: 'Message Sent!',
                            text: 'Thank you for contacting us. We will get back to you within 24 hours.',
                            icon: 'success',
                            confirmButtonColor: '#0d6efd',
                            timer: 3000,
                            timerProgressBar: true
                        });
                        
                        // Close modal
                        const contactModal = bootstrap.Modal.getInstance(document.getElementById('contactModal'));
                        if (contactModal) {
                            contactModal.hide();
                        }
                        
                        // Reset form validation state
                        this.classList.remove('was-validated');
                        
                        // Reset form inputs
                        this.reset();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        
                        // Show error message
                        Swal.fire({
                            title: 'Message Not Sent',
                            text: 'Sorry, there was a problem sending your message. Please try again or use another contact method.',
                            icon: 'error',
                            confirmButtonColor: '#dc3545'
                        });
                    })
                    .finally(() => {
                        // Restore button state
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    });
                });

                // Real-time validation feedback
                const formInputs = contactForm.querySelectorAll('input, textarea');
                formInputs.forEach(input => {
                    input.addEventListener('blur', function() {
                        // Check validity when input loses focus
                        if (this.checkValidity()) {
                            this.classList.remove('is-invalid');
                            this.classList.add('is-valid');
                        } else {
                            this.classList.remove('is-valid');
                            this.classList.add('is-invalid');
                        }
                    });
                });
            }
            
            // Check if we're on a buy page (Keep this functionality from your original code)
            const footer = document.querySelector('footer');
            if (footer) {
                if (window.location.pathname.includes('buy') || window.location.href.includes('buy.html')) {
                    footer.style.display = 'none';
                } else {
                    footer.style.display = 'block';
                }
            }
        });
        // Global variables
        let currentUser = null;
        let currentListingId = null;
        let currentMessageThreadId = null;
        let currentOtherUserId = null;

        // Function to open the report modal
        function openReportModal() {
            console.log("Opening report modal");
            
            if (!currentListingId || !currentMessageThreadId) {
                console.error("Missing listing ID or message thread ID for report");
                // Try to get from URL if available
                const urlParams = new URLSearchParams(window.location.search);
                const listingId = urlParams.get('listing');
                
                if (listingId) {
                    currentListingId = listingId;
                } else {
                    showAlert('Error', 'Cannot report at this time. Please try again later.', 'error');
                    return;
                }
            }
            
            // Set values in the hidden fields
            document.getElementById('reportListingId').value = currentListingId;
            document.getElementById('reportMessageThreadId').value = currentMessageThreadId || '';
            
            const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            reportModal.show();
        }
        
        // Handle loading messages in the chat
        async function loadMessages(otherUserId, listingId) {
            try {
                console.log(`Loading messages for user ${otherUserId} and listing ${listingId}`);
                currentOtherUserId = otherUserId;
                currentListingId = listingId;
                
                const response = await fetch(`/api/messages?other_user_id=${otherUserId}&listing_id=${listingId}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to load messages');
                
                const data = await response.json();
                const messages = data.messages || [];
                
                console.log(`Loaded ${messages.length} messages`);
                
                // Set the first message's ID as the thread ID for reporting
                if (messages && messages.length > 0) {
                    currentMessageThreadId = messages[0].id;
                    console.log(`Set message thread ID to ${currentMessageThreadId}`);
                } else {
                    // If no messages exist yet, we need to create a placeholder message thread ID
                    // This can be a timestamp or other unique identifier
                    currentMessageThreadId = `temp_${Date.now()}`;
                    console.log(`No messages found, using temporary ID: ${currentMessageThreadId}`);
                }
                
                // Update the chat window UI with messages...
                // [existing message display code]
                
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }
        
        // Handle report form submission
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            const listingId = document.getElementById('reportListingId').value;
            const messageThreadId = document.getElementById('reportMessageThreadId').value;
            const description = document.getElementById('reportDescription').value;
            
            if (!description) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please describe the issue you\'re reporting.'
                });
                return;
            }
            
            // Always ensure we have a message thread ID (even if temporary)
            if (!messageThreadId) {
                const tempId = `temp_${Date.now()}`;
                console.log("Created temporary ID for form submission:", tempId);
                formData.append('message_thread_id', tempId);
            } else {
                formData.append('message_thread_id', messageThreadId);
            }
            
            // Add listing ID if available
            if (listingId) {
                formData.append('listing_id', listingId);
            }
            
            formData.append('description', description);
            
            const reportImage = document.getElementById('reportImage').files[0];
            if (reportImage) {
                formData.append('image', reportImage);
            }
            
            try {
                // Show loading state
                Swal.fire({
                    title: 'Submitting report...',
                    text: 'Please wait',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                const response = await fetch('/api/report/create', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Report Submitted',
                        text: 'Thank you for your report. We will review it shortly.'
                    });
                    closeReportModal();
                    
                    // Clear the form
                    document.getElementById('reportDescription').value = '';
                    document.getElementById('reportImage').value = '';
                    document.getElementById('reportPreviewImage').classList.add('d-none');
                } else {
                    throw new Error(data.error || 'Failed to submit report');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message
                });
            }
        });

        // Preview report image
        document.getElementById('reportImage').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const preview = document.getElementById('reportPreviewImage');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('d-none');
            }
        });
        
        // Enhanced JavaScript functionality
        const modals = {
            login: new bootstrap.Modal(document.getElementById('loginModal')),
            register: new bootstrap.Modal(document.getElementById('registerModal')),
            createListing: new bootstrap.Modal(document.getElementById('createListingModal'))
        };

        // Add this function to handle path selection
        // Update the handlePathSelection function:
        function handlePathSelection(path) {
            currentPath = path;
            
            if (!currentUser) {
                showLoginModal();
                return;
            }
            
            const heroSection = document.querySelector('.hero-section');
            const searchSection = document.querySelector('.search-section');
            const listingsSection = document.getElementById('listingsSection');
            
            if (path === 'buy') {
                // Hide hero, show search and listings
                heroSection.style.display = 'none';
                searchSection.style.display = 'block';
                listingsSection.style.display = 'block';
                
                // Set the college filter to user's college by default
                if (currentUser && currentUser.college) {
                    const collegeFilter = document.getElementById('collegeFilter');
                    collegeFilter.value = currentUser.college;
                }
                
                loadListings();
            } else if (path === 'sell') {
                showCreateListing();
            }
        }

        // Add this to your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', () => {
            // ... existing code ...

            // Hide search section by default on home page
            const searchSection = document.querySelector('.search-section');
            if (searchSection) {
                searchSection.style.display = 'none';
            }

            // Only show search section if we're on a specific path
            if (currentPath === 'buy') {
                searchSection.style.display = 'block';
            }
            const collegeFilter = document.getElementById('collegeFilter');
            if (currentUser && currentUser.college) {
                collegeFilter.value = currentUser.college;
            }
            
            // Add event listener for college filter change
            collegeFilter.addEventListener('change', function() {
                loadListings();
            });

            // ... rest of your code ...
        });

        // Utility Functions
        function showLoading() {
            document.getElementById('loadingSkeleton').style.display = 'flex';
            document.getElementById('listingsGrid').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loadingSkeleton').style.display = 'none';
            document.getElementById('listingsGrid').style.display = 'flex';
        }

        function showAlert(title, text, icon) {
            Swal.fire({
                title,
                text,
                icon,
                confirmButtonColor: '#2563eb'
            });
        }

        // Modal Functions
        function showLoginModal() {
            modals.login.show();
        }

        function showRegisterModal() {
            modals.register.show();
        }

        function showCreateListing() {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to create a listing', 'warning');
                return;
            }
            modals.createListing.show();
        }

        // Authentication Functions
        function updateAuthUI() {
            if (currentUser) {
                // Show user menu, hide auth buttons
                document.getElementById('userMenu').classList.remove('d-none');
                document.getElementById('authButtons').classList.add('d-none');
                document.getElementById('userName').textContent = currentUser.full_name;
                
                // Show admin menu if user is admin
                if (currentUser.is_admin) {
                    document.getElementById('adminMenu').classList.remove('d-none');
                    document.getElementById('reportsMenu').classList.remove('d-none');
                    
                    // Get report count
                    fetch('/admin/dashboard')
                        .then(response => response.json())
                        .then(data => {
                            const pendingReports = data.stats.pending_reports || 0;
                            document.getElementById('navReportsBadge').textContent = pendingReports;
                            
                            if (pendingReports > 0) {
                                document.getElementById('navReportsBadge').style.display = 'inline-block';
                            } else {
                                document.getElementById('navReportsBadge').style.display = 'none';
                            }
                        })
                        .catch(error => console.error('Error fetching report counts:', error));
                } else {
                    document.getElementById('adminMenu').classList.add('d-none');
                    document.getElementById('reportsMenu').classList.add('d-none');
                }
            } else {
                // Show auth buttons, hide user menu
                document.getElementById('userMenu').classList.add('d-none');
                document.getElementById('authButtons').classList.remove('d-none');
                document.getElementById('adminMenu').classList.add('d-none');
                document.getElementById('reportsMenu').classList.add('d-none');
            }
        }

        async function logout() {
            try {
                await fetch('/logout', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                // Clear all admin-related localStorage items
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminDashboardOpen');
                
                currentUser = null;
                updateAuthUI();
                
                // Show success message
                Swal.fire({
                    title: 'Success',
                    text: 'Logged out successfully',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Reset any path-specific UI elements
                const heroSection = document.querySelector('.hero-section');
                const listingsSection = document.getElementById('listingsSection');
                
                // Show hero section (home page) and hide listings section
                heroSection.style.display = 'flex';
                listingsSection.style.display = 'none';
                
                // Reset current path
                currentPath = null;
                
                // Optionally, you could redirect to the root URL after a short delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } catch (error) {
                showAlert('Error', 'Failed to logout', 'error');
            }
        }

        // Listing Functions
        async function loadListings() {
            showLoading();
            try {
                // Get filters with proper encoding
                const query = encodeURIComponent(document.getElementById('searchInput').value);
                const category = encodeURIComponent(document.getElementById('categoryFilter').value);
                const college = currentUser ? encodeURIComponent(currentUser.college) : '';
                const sort = document.getElementById('sortFilter').value;
        
                // Sorting logic
                let sortBy = 'created_at';
                if (sort === 'price_low') sortBy = 'price_asc';
                if (sort === 'price_high') sortBy = 'price_desc';
        
                console.debug("Fetching listings with params:", { query, category, college, sortBy });
        
                const response = await fetch(
                    `/listings?q=${query}&category=${category}&college=${college}&sort_by=${sortBy}`,
                    { credentials: 'same-origin' }
                );
        
                if (!response.ok) throw new Error(`HTTP ${response.status} - ${await response.text()}`);
        
                const { listings } = await response.json();
                console.debug("API Response:", listings);
        
                const grid = document.getElementById('listingsGrid');
                grid.innerHTML = '';
        
                if (listings.length === 0) {
                    grid.innerHTML = `
                        <div class="col-12 text-center my-5">
                            <h4>No listings found</h4>
                            ${college ? `<p class="text-muted">Try adjusting filters or search terms</p>` : ''}
                        </div>`;
                    return;
                }
        
                listings.forEach(listing => {
                    console.debug("Processing listing:", listing.id, listing);
                    const isSoftCopy = Boolean(listing.is_softcopy);
                    const card = document.createElement('div');
                    card.className = 'col-md-4 col-lg-3 mb-4';
        
                    // Image handling with fallback
                    const imageUrl = listing.image_url?.startsWith('http') 
                        ? listing.image_url 
                        : `/static/${listing.image_url || 'images/placeholder.jpg'}`;
        
                    // In your loadListings function, update the card HTML to include faculty name
                    card.innerHTML = `
                        <div class="card listing-card h-100">
                            <div class="card-img-top position-relative">
                                <img src="${imageUrl}" 
                                    class="listing-image" 
                                    alt="${listing.title}"
                                    loading="lazy">
                                
                                ${listing.is_softcopy ? `
                                <div class="position-absolute top-0 start-0 m-2">
                                    <span class="badge bg-info">
                                        <i class="fas fa-file-pdf me-1"></i>Digital Copy
                                    </span>
                                </div>` : ''}
                            </div>
                        
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${listing.title}</h5>
                                
                                ${listing.faculty_name ? `
                                <div class="faculty-badge mb-2">
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-chalkboard-teacher me-1"></i>${listing.faculty_name}
                                    </span>
                                </div>` : ''}
                                
                                <div class="price-display mb-2">
                                    ${listing.is_for_rent ?
                                    `<span class="text-success fw-bold">?${listing.rent_price}</span>
                                        <small class="text-muted">/day</small>` :
                                    `<span class="text-primary fw-bold">?${listing.price}</span>
                                        ${listing.is_softcopy ? '<small class="text-muted">(Digital Edition)</small>' : ''}`}
                                </div>
                            
                                <div class="badge-container mb-2">
                                    <span class="badge bg-primary">${listing.category}</span>
                                    ${listing.branch ? `<span class="badge bg-secondary">${listing.branch}</span>` : ''}
                                    ${listing.condition && `<span class="badge bg-secondary">${listing.condition}</span>`}
                                    ${listing.is_for_rent ?
                                    '<span class="badge bg-success">For Rent</span>' :
                                    '<span class="badge bg-info">For Sale</span>'}
                                </div>
                            
                                <div class="seller-info mb-3">
                                    <small class="text-muted">
                                        <i class="fas fa-user-circle me-1"></i>
                                        ${listing.seller?.name || 'Unknown Seller'}
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-university me-1"></i>
                                        ${listing.seller?.college || 'College not specified'}
                                    </small>
                                </div>
                            
                                ${listing.is_softcopy ?
                                    `<a href="/download/${listing.id}" 
                                        class="btn btn-success btn-download w-100 mb-2"
                                        onclick="return handleDownload(${listing.id}, '${listing.title}', event)">
                                        <i class="fas fa-download me-2"></i>Download PDF
                                    </a>` :
                                    `<button class="btn btn-primary w-100 mb-2" 
                                            onclick="contactSeller(${listing.id})">
                                        <i class="fas fa-envelope me-2"></i>Contact Seller
                                    </button>`}
                            
                                <button id="wishlist-btn-${listing.id}" 
                                        class="btn btn-outline-primary w-100 mt-auto" 
                                        onclick="addToWishlist(${listing.id})">
                                    <i class="fas fa-heart me-2"></i>Wishlist
                                </button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Listing load error:', error);
                showAlert('Error', `Failed to load listings: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
        // Add this to your main.js file or include it as a script
        (async function debugAPI() {
            try {
            const response = await fetch('/listings', {credentials: 'same-origin'});
            const data = await response.json();
            console.log("All listings data:", data);
            
            // Check specifically for the CFGVBHJN listing
            const targetListing = data.listings.find(l => l.title === "CFGVBHJN");
            if (targetListing) {
                console.log("Target listing found:", targetListing);
                console.log("is_softcopy value:", targetListing.is_softcopy);
                console.log("file_url value:", targetListing.file_url);
            } else {
                console.log("Target listing 'CFGVBHJN' not found in response");
            }
            } catch (error) {
            console.error("Debug API error:", error);
            }
        })();

        async function contactSeller(listingId) {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to contact sellers', 'warning');
                return;
            }
            
            try {
                // First get the listing details
                const response = await fetch(`/listings?id=${listingId}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to fetch listing details');
                
                const data = await response.json();
                const listing = data.listings[0];
                
                const { value: message } = await Swal.fire({
                    title: 'Send Message to Seller',
                    input: 'textarea',
                    inputLabel: 'Your message',
                    inputPlaceholder: 'Type your message here...',
                    inputAttributes: {
                        'aria-label': 'Type your message here'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Send Message',
                    showLoaderOnConfirm: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to write something!'
                        }
                    },
                    preConfirm: (message) => {
                        // This function runs when the user clicks "Send Message"
                        return fetch('/api/messages/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            receiver_id: listing.seller.id,
                            listing_id: listingId,
                            content: message
                        }),
                        credentials: 'same-origin'
                        })
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to send message');
                            return response.json();
                        })
                        .catch(error => {
                            Swal.showValidationMessage(`Request failed: ${error.message}`);
                        });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });
                
                if (message) {
                    // This runs after the message was successfully sent
                    Swal.fire({
                        title: 'Message Sent!',
                        text: 'Your message has been sent to the seller.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Optionally, you can open the chat modal to show the conversation
                    setTimeout(() => {
                        const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
                        chatModal.show();
                        // This will find and open the chat with the seller
                        setTimeout(() => {
                            const chatItems = document.querySelectorAll('.chat-item');
                            const sellerName = listing.seller.name;
                            for (const item of chatItems) {
                                if (item.querySelector('h6').textContent === sellerName) {
                                    item.click();
                                    break;
                                }
                            }
                        }, 500);
                    }, 2000);
                }
            } catch (error) {
                console.error('Error contacting seller:', error);
                showAlert('Error', error.message, 'error');
            }
        }
        

        async function addToWishlist(listingId) {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to add items to wishlist', 'warning');
                return;
            }
            
            try {
                // Show loading state on the button if possible
                const wishlistButton = event.target.closest('button');
                if (wishlistButton) {
                    const originalText = wishlistButton.innerHTML;
                    wishlistButton.disabled = true;
                    wishlistButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
                }
                
                const response = await fetch('/api/wishlist/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ listing_id: listingId }),
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error || 'Failed to add to wishlist');
                
                // Show success feedback
                Swal.fire({
                    title: 'Added to Wishlist!',
                    text: data.message || 'Item has been added to your wishlist',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Visual feedback on the button if it exists
                if (wishlistButton) {
                    wishlistButton.innerHTML = '<i class="fas fa-heart me-2"></i>Added to Wishlist';
                    wishlistButton.classList.remove('btn-outline-primary');
                    wishlistButton.classList.add('btn-success');
                    
                    // Disable the button to prevent multiple additions
                    setTimeout(() => {
                        wishlistButton.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Wishlist error:', error);
                showAlert('Error', error.message, 'error');
                
                // Reset button if it exists
                if (wishlistButton) {
                    wishlistButton.disabled = false;
                    wishlistButton.innerHTML = '<i class="fas fa-heart me-2"></i>Add to Wishlist';
                }
            }
        }
        function populateCollegeDropdowns() {
            const sortedColleges = colleges.sort();
            
            // Populate registration form dropdown
            const registerForm = document.getElementById('collegeSelect');
            sortedColleges.forEach(college => {
                const option = document.createElement('option');
                option.value = college;
                option.textContent = college;
                registerForm.appendChild(option);
            });
        
            // Populate search filter dropdown
            const filterSelect = document.getElementById('collegeFilter');
            sortedColleges.forEach(college => {
                const option = document.createElement('option');
                option.value = college;
                option.textContent = college;
                filterSelect.appendChild(option);
            });
        }

        
        
        

        async function showMessages() {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to view your messages', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/messages', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to fetch messages');
                
                const data = await response.json();
                
                const messagesHtml = data.messages.map(message => {
                    const repliesHtml = message.replies.map(reply => `
                        <div class="card-body border-start border-primary ms-4 mt-2">
                            <h6 class="card-subtitle mb-2 text-muted">
                                Reply from ${reply.sender.name}
                            </h6>
                            <p class="card-text">${reply.content}</p>
                            <p class="card-text">
                                <small class="text-muted">
                                    ${new Date(reply.created_at).toLocaleString()}
                                </small>
                            </p>
                        </div>
                    `).join('');
                    
                    return `
                        <div class="card mb-3 ${message.sender.id === currentUser.id ? 'border-primary' : 'border-success'}">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">
                                    ${message.sender.id === currentUser.id ? 'Sent to' : 'From'}: 
                                    ${message.sender.id === currentUser.id ? message.receiver.name : message.sender.name}
                                </h6>
                                <p class="card-text">${message.content}</p>
                                <p class="card-text">
                                    <small class="text-muted">
                                        Re: ${message.listing.title}
                                        <br>
                                        ${new Date(message.created_at).toLocaleString()}
                                    </small>
                                </p>
                                <button class="btn btn-sm btn-primary" onclick="replyToMessage(${message.id}, '${message.sender.id === currentUser.id ? message.receiver.name : message.sender.name}')">
                                    <i class="fas fa-reply me-2"></i>Reply
                                </button>
                            </div>
                            ${repliesHtml}
                        </div>
                    `;
                }).join('');
                
                Swal.fire({
                    title: 'My Messages',
                    html: `<div class="messages-container">${messagesHtml}</div>`,
                    width: '80%',
                    confirmButtonText: 'Close'
                });
            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }
        
        async function replyToMessage(messageId, recipientName) {
            try {
                const { value: content } = await Swal.fire({
                    title: `Reply to ${recipientName}`,
                    input: 'textarea',
                    inputLabel: 'Your reply',
                    inputPlaceholder: 'Type your reply here...',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'You need to write something!';
                        }
                    }
                });
                
                if (content) {
                    const response = await fetch('/api/messages/reply', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            parent_message_id: messageId,
                            content: content
                        }),
                        credentials: 'same-origin'
                    });
                    
                    if (!response.ok) throw new Error('Failed to send reply');
                    
                    showAlert('Success', 'Reply sent successfully', 'success');
                    showMessages(); // Refresh the messages view
                }
            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }

        // Check session status on page load
        async function checkSession() {
            try {
                const response = await fetch('/check-session', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        currentUser = data.user;
                        
                        // Clear any existing admin status in localStorage first
                        if (!currentUser.is_admin) {
                            localStorage.removeItem('isAdmin');
                            localStorage.removeItem('adminDashboardOpen');
                            console.log("Cleared admin status from localStorage for non-admin user");
                        } else {
                            // Only set admin status if the current authenticated user is an admin
                            localStorage.setItem('isAdmin', 'true');
                            console.log("Admin status stored in localStorage");
                        }
                        
                        updateAuthUI();
                        
                        // Only use localStorage admin status if the user is actually an admin
                        // This prevents a non-admin from getting admin privileges
                        if (localStorage.getItem('isAdmin') === 'true' && currentUser.is_admin) {
                            console.log("Admin status confirmed, enabling admin features");
                            
                            // Show admin elements right away
                            document.getElementById('adminMenu').classList.remove('d-none');
                            document.getElementById('reportsMenu').classList.remove('d-none');
                            
                            // If the adminDashboardModal was open before refresh, reopen it
                            if (localStorage.getItem('adminDashboardOpen') === 'true') {
                                console.log("Reopening admin dashboard after refresh");
                                setTimeout(() => {
                                    showAdminDashboard();
                                }, 500);
                            }
                        }
                        
                        // If page is loaded with admin flag, show dashboard only if user is admin
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('admin') === 'true' && currentUser.is_admin) {
                            showAdminDashboard();
                        }
                    } else {
                        // Not authenticated, clear any admin status
                        localStorage.removeItem('isAdmin');
                        localStorage.removeItem('adminDashboardOpen');
                    }
                }
            } catch (error) {
                console.error('Session check failed:', error);
            }
        }

        // Event Listeners
        // Modify your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', () => {
            const collegeFilter = document.getElementById('collegeFilter');
            if (currentUser && currentUser.college) {
                collegeFilter.value = currentUser.college;
            }
            
            // Add event listener for college filter change
            collegeFilter.addEventListener('change', function() {
                loadListings();
            });
        
            // Create skeleton loading cards
            const skeleton = document.getElementById('loadingSkeleton');
            for (let i = 0; i < 8; i++) {
                skeleton.innerHTML += `
                <div class="col-md-4 col-lg-3">
                    <div class="listing-card">
                        <div class="skeleton-loading" style="height: 200px;"></div>
                        <div class="listing-content">
                            <div class="skeleton-loading" style="height: 24px; width: 80%; margin-bottom: 12px;"></div>
                            <div class="skeleton-loading" style="height: 18px; width: 60%; margin-bottom: 12px;"></div>
                            <div class="skeleton-loading" style="height: 18px; width: 40%; margin-bottom: 12px;"></div>
                        </div>
                    </div>
                </div>
                `;
            }
        
            // Check if user is logged in
            checkSession();
            populateCollegeDropdowns();
           
            // Add event listeners for search and filters
            document.getElementById('searchInput').addEventListener('input', debounce(loadListings, 500));
            document.getElementById('categoryFilter').addEventListener('change', loadListings);
            document.getElementById('sortFilter').addEventListener('change', loadListings);
            document.getElementById('collegeFilter').addEventListener('change', loadListings);
        
            // Initialize my listings page if we're on that page
            initializeMyListingsPage();
            
            // Initialize wishlist page if we're on that page
            initializeWishlistPage();
        });
        async function showMyListings() {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to view your listings', 'warning');
                return;
            }
            // Open in new tab
            window.open('/my-listings', '_self')
        }

        // Add this function to handle the my-listings page load
        function initializeMyListingsPage() {
            if (window.location.pathname === '/my-listings') {
              const heroSection = document.querySelector('.hero-section');
              const searchSection = document.querySelector('.search-section');
              const listingsSection = document.getElementById('listingsSection');
              
              if (heroSection) heroSection.style.display = 'none';
              if (searchSection) searchSection.style.display = 'none';
              if (listingsSection) listingsSection.style.display = 'block';
              
              // Show loading state
              const listingsGrid = document.getElementById('listingsGrid');
              if (listingsGrid) {
                listingsGrid.innerHTML = '<div class="text-center w-100 py-5"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
                
                // Load my listings
                fetch('/api/my-listings', {
                  credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                  // Create the header with title and create button
                  listingsGrid.innerHTML = `
                    <div class="col-12 mb-4">
                      <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">My Listings</h2>
                        <button class="btn btn-primary" onclick="showCreateListing()">
                          <i class="fas fa-plus-circle me-2"></i>Create New Listing
                        </button>
                      </div>
                    </div>
                  `;
                  
                  if (data.listings.length === 0) {
                    listingsGrid.innerHTML += `
                      <div class="col-12 text-center">
                        <div class="alert alert-info">
                          <i class="fas fa-info-circle me-2"></i>
                          You haven't created any listings yet.
                        </div>
                      </div>
                    `;
                    return;
                  }
                  
                  // Add each listing to the grid
                  data.listings.forEach(listing => {
                    const imageUrl = listing.image_url.startsWith('http') ? 
                      listing.image_url : `/static/${listing.image_url}`;
                    
                    listingsGrid.innerHTML += `
                      <div class="col-md-4 mb-4">
                        <div class="card h-100">
                          <img src="${imageUrl}" class="card-img-top" alt="${listing.title}" 
                            style="height: 200px; object-fit: cover;">
                          <div class="card-body">
                            <h5 class="card-title">${listing.title}</h5>
                            <p class="card-text text-muted">?${listing.price}</p>
                            <p class="card-text">${listing.description.substring(0, 100)}${listing.description.length > 100 ? '...' : ''}</p>
                            <div class="d-flex gap-2 mb-3">
                              <span class="badge bg-primary">${listing.category}</span>
                              <span class="badge bg-secondary">${listing.condition}</span>
                            </div>
                            <div class="d-flex gap-2">
                              
                              <button class="btn btn-outline-danger btn-sm flex-grow-1" 
                                onclick="deleteListing(${listing.id})">
                                <i class="fas fa-trash me-2"></i>Delete
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    `;
                  });
                })
                .catch(error => {
                  showAlert('Error', error.message, 'error');
                });
              }
            }
          }
        
        async function showWishlist() {
            if (!currentUser) {
                showAlert('Please Login', 'You need to login to view your wishlist', 'warning');
                return;
            }
            
            // Redirect to the wishlist page
            window.open('/my-wishlist', '_self')
        }
        
        // Add this function to handle the wishlist page initialization
        function initializeWishlistPage() {
            if (window.location.pathname === '/my-wishlist') {
                const heroSection = document.querySelector('.hero-section');
                const searchSection = document.querySelector('.search-section');
                
                if (heroSection) heroSection.style.display = 'none';
                if (searchSection) searchSection.style.display = 'none';
                
                // Show loading state
                const listingsGrid = document.getElementById('listingsGrid');
                if (listingsGrid) {
                    listingsGrid.innerHTML = '<div class="text-center w-100 py-5"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
                    
                    // Load wishlist items
                    fetch('/api/wishlist', {
                        credentials: 'same-origin'
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Create the header with title
                        listingsGrid.innerHTML = `
                        <div class="col-12 mb-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <h2 class="mb-0">My Wishlist</h2>
                            </div>
                        </div>
                        `;
                        
                        if (data.items.length === 0) {
                            listingsGrid.innerHTML += `
                            <div class="col-12 text-center">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Your wishlist is empty. Browse listings to add items to your wishlist.
                                </div>
                            </div>
                            `;
                            return;
                        }
                        
                        // Add each wishlist item to the grid
                        data.items.forEach(item => {
                            const imageUrl = item.listing.image_url.startsWith('http') ? 
                                item.listing.image_url : `/static/${item.listing.image_url}`;
                            
                            listingsGrid.innerHTML += `
                            <div class="col-md-4 mb-4">
                                <div class="card h-100">
                                    <img src="${imageUrl}" class="card-img-top" alt="${item.listing.title}" 
                                        style="height: 200px; object-fit: cover;">
                                    <div class="card-body">
                                        <h5 class="card-title">${item.listing.title}</h5>
                                        <p class="card-text text-muted">?${item.listing.price}</p>
                                        <p class="card-text">Seller: ${item.listing.seller.name}</p>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-primary btn-sm flex-grow-1" 
                                                onclick="contactSeller(${item.listing.id})">
                                                <i class="fas fa-envelope me-2"></i>Contact Seller
                                            </button>
                                            <button class="btn btn-danger btn-sm flex-grow-1" 
                                                onclick="removeFromWishlist(${item.id})">
                                                <i class="fas fa-trash me-2"></i>Remove
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            `;
                        });
                    })
                    .catch(error => {
                        showAlert('Error', error.message, 'error');
                    });
                }
            }
        }
        
        // Add this function to remove items from wishlist
        async function removeFromWishlist(wishlistId) {
            try {
                const result = await Swal.fire({
                    title: 'Remove from Wishlist',
                    text: 'Are you sure you want to remove this item from your wishlist?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, remove it!'
                });
                
                if (result.isConfirmed) {
                    const response = await fetch(`/api/wishlist/${wishlistId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                    
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'Failed to remove from wishlist');
                    }
                    
                    Swal.fire(
                        'Removed!',
                        'The item has been removed from your wishlist.',
                        'success'
                    );
                    
                    // Refresh the wishlist page
                    initializeWishlistPage();
                }
            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }
        
        function viewListing(listingId) {
            // Fetch the listing details
            fetch(`/listings?id=${listingId}`, {
            credentials: 'same-origin'
            })
            .then(response => {
            if (!response.ok) throw new Error('Failed to fetch listing details');
            return response.json();
            })
            .then(data => {
            if (!data.listings || data.listings.length === 0) {
                throw new Error('Listing not found');
            }
            
            const listing = data.listings[0];
            
            // Create a modal to display the listing details
            Swal.fire({
                title: listing.title,
                html: `
                <div class="text-center mb-3">
                    <img src="${listing.image_url.startsWith('http') ? listing.image_url : `/static/${listing.image_url}`}" 
                        class="img-fluid rounded" style="max-height: 300px;" alt="${listing.title}">
                </div>
                <div class="text-start">
                    <p class="mb-2"><strong>Price:</strong> ?${listing.price}</p>
                    <p class="mb-2"><strong>Category:</strong> ${listing.category}</p>
                    <p class="mb-2"><strong>Condition:</strong> ${listing.condition}</p>
                    <p class="mb-2"><strong>Seller:</strong> ${listing.seller.name}</p>
                    <p class="mb-2"><strong>Description:</strong> ${listing.description}</p>
                </div>
                `,
                width: '600px',
                showCancelButton: true,
                confirmButtonText: 'Contact Seller',
                cancelButtonText: 'Close'
            }).then((result) => {
                if (result.isConfirmed) {
                contactSeller(listing.id);
                }
            });
            })
            .catch(error => {
            console.error('Error viewing listing:', error);
            showAlert('Error', error.message, 'error');
            });
        }
        async function deleteListing(listingId) {
            try {
            // Confirm before deleting
            const result = await Swal.fire({
                title: 'Delete Listing?',
                text: 'Are you sure you want to delete this listing? This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            });
            
            if (result.isConfirmed) {
                // Show loading state
                Swal.fire({
                title: 'Deleting...',
                text: 'Please wait while we delete your listing.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
                });
                
                const response = await fetch(`/api/listings/${listingId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
                });
                
                if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to delete listing');
                }
                
                // Show success message
                Swal.fire({
                title: 'Deleted!',
                text: 'Your listing has been deleted successfully.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
                });
                
                // Refresh the listings
                if (window.location.pathname === '/my-listings') {
                initializeMyListingsPage();
                }
            }
            } catch (error) {
            console.error('Error deleting listing:', error);
            Swal.fire({
                title: 'Error',
                text: error.message,
                icon: 'error'
            });
            }
        }
        
        // Function to delete a listing
        
        // Form submission handlers with enhanced error handling and validation
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalButtonText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            
            try {
                const formData = new FormData(this);
                const response = await fetch('/login', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store user data including admin status
                    currentUser = data.user;
                    sessionStorage.setItem('user', JSON.stringify(data.user));
                    
                    // Manage admin status in localStorage based on user's role
                    if (data.user.is_admin) {
                        localStorage.setItem('isAdmin', 'true');
                    } else {
                        // Clear admin status if user is not an admin
                        localStorage.removeItem('isAdmin');
                        localStorage.removeItem('adminDashboardOpen');
                    }
                    
                    // Close the login modal
                    const loginModal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    if (loginModal) {
                        loginModal.hide();
                    }
                    
                    // Show success message
                    let successMessage = 'Welcome back, ' + data.user.full_name + '!';
                    if (data.user.is_admin) {
                        successMessage += ' (Admin Mode)';
                    }
                    
                    Swal.fire({
                        title: 'Login Successful!',
                        text: successMessage,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Update UI based on user role
                    updateAuthUI();
                    
                    // If admin, show admin dashboard after login
                    if (data.user.is_admin) {
                        setTimeout(() => {
                            showAdminDashboard('reports');
                        }, 2000);
                    }
                    
                    // Reset the form
                    this.reset();
                    
                } else {
                    // Handle login errors
                    Swal.fire({
                        title: 'Login Error',
                        text: data.error || 'Invalid credentials. Please try again.',
                        icon: 'error'
                    });
                }
            } catch (error) {
                console.error('Login error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An unexpected error occurred. Please try again.',
                    icon: 'error'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalButtonText;
            }
        });
        const colleges = [
            "Anantha Lakshmi Institute of Technology and Sciences",
            "Balaji College of Pharmacy",
            "Chiranjeevi Reddy Institute of Engineering and Technology",
            "Gates Institute of Technology",
            "Intell Engineering College",
            "PVKK Institute of Technology",
            "Raghavendra Institute of Pharmaceutical Education and Research",
            "Sri Krishna Devaraya Engineering College",
            "Sri Venkateswara Institute of Technology",
            "Srinivasa Ramanujan Institute of Technology",
            "Aditya College of Engineering",
            "Annamacharya Institute of Technology and Sciences",
            "Mother Theresa Institute of Engineering and Technology",
            "Siddharth Institute of Engineering and Technology",
            "Sree Vidyanikethan Engineering College",
            "Sri Venkateswara College of Engineering and Technology",
            "Sri Venkateswara Engineering College for Women",
            "Vemu Institute of Technology",
            "Yogananda Institute of Technology and Science",
            "Bheema Institute of Technology and Science",
            "Dr. K.V. Subba Reddy Institute of Technology",
            "G. Pulla Reddy Engineering College",
            "G. Pullaiah College of Engineering and Technology",
            "Kottam College of Engineering",
            "Safa College of Engineering and Technology",
            "St. Johns College of Engineering and Technology",
            "Stanley Stephen College of Engineering and Technology",
            "Syamaladevi Institute of Technology for Women",
            "Rajeev Gandhi Memorial College of Engineering and Technology",
            "Santhiram Engineering College",
            "SVR Engineering College",
            "Prabhath Institute of Pharmacy",
            "Santhiram College of Pharmacy",
            "Audisankara College of Engineering and Technology",
            "Geethanjali Institute of Science and Technology",
            "Narayana Engineering College",
            "Priyadarshini College of Engineering",
            "Quba College of Engineering and Technology",
            "Rami Reddy Subbarami Reddy Engineering College",
            "Sree Venkateswara College of Engineering",
            "Visvodaya Engineering College",
            "Balaji Institute of Technology and Science",
            "Chaitanya Bharathi Institute of Technology",
            "K.S.R.M. College of Engineering",
            "Kandula Obula Reddy Memorial College of Engineering",
            "Madanapalle Institute of Technology and Science",
            "Vaagdevi Institute of Technology and Science",
            "A V N COLLEGE",
            "ABHINAV HI-TECH COLLEGE",
            "ABR COLLEGE",
            "ACE ENGINEERING COLLEGE",
            "ACHARYA COLLEGE",
            "ADAM'S ENGINEERING COLLEGE",
            "ADARSH COLLEGE",
            "ADITYA COLLEGE",
            "ADITYA ENGINEERING COLLEGE",
            "ADUSUMILLI VIJAYA COLLEGE",
            "AIZZA COLLEGE",
            "AKULA SREERAMULU COLLEGE",
            "AL HABEEB COLLEGE",
            "ALFA COLLEGE",
            "ANDHRA UNIVERSITY COLLEGE",
            "ANN'S COLLEGE",
            "ANU COLLEGE",
            "ANURAG COLLEGE",
            "ANURAG ENGINEERING COLLEGE",
            "ANWAR UL ULOOM COLLEGE",
            "APEX ENGINEERING COLLEGE",
            "ARIES POLYTECHNIC COLLEGE",
            "ARJUN COLLEGE",
            "ARKAY COLLEGE",
            "ASIFIA COLLEGE",
            "ATMAKUR ENGINEERING COLLEGE",
            "AUDISANKARA COLLEGE",
            "AURORA'S ENGINEERING COLLEGE",
            "AVANTHI POLYTECHNIC COLLEGE",
            "AVR&SVR COLLEGE",
            "AVS COLLEGE",
            "AWARE MADHAVANJI COLLEGE",
            "AYAAN COLLEGE",
            "AZAD COLLEGE",
            "B V C COLLEGE",
            "BANDARI SRINIVAS COLLEGE",
            "BAPATLA ENGINEERING COLLEGE",
            "BHAGATH COLLEGE",
            "BHARATH COLLEGE",
            "BHASKAR ENGINEERING COLLEGE",
            "BRAHMAIAH COLLEGE",
            "CHAITANYA ENGINEERING COLLEGE",
            "CHEBROLU ENGINEERING COLLEGE",
            "CHIRALA ENGINEERING COLLEGE",
            "CHITTOOR POLYTECHNIC COLLEGE",
            "CITY WOMENS COLLEGE",
            "CMR COLLEGE",
            "CMR ENGINEERING COLLEGE",
            "CVR COLLEGE",
            "DJR COLLEGE",
            "DNR COLLEGE",
            "DR LANKAPALLI BULLAYYA COLLEGE",
            "DRK COLLEGE",
            "DVR COLLEGE",
            "ELENKI ENGINEERING COLLEGE",
            "ELLENKI COLLEGE",
            "ELURU COLLEGE",
            "ENGINEERING COLLEGE",
            "ESWAR COLLEGE",
            "EVM COLLEGE",
            "EVR COLLEGE",
            "GANAPATHY COLLEGE",
            "GAYATRI VIDYA PARISHAD COLLEGE",
            "GEETHANJALI COLLEGE",
            "GIET COLLEGE",
            "GIET POLYTECHNIC COLLEGE",
            "GLOBAL COLLEGE",
            "GNYANA SARASWATI COLLEGE",
            "GOKULA KRISHNA COLLEGE",
            "GOPAL REDDY COLLEGE",
            "GUNTUR ENGINEERING COLLEGE",
            "HI-POINT COLLEGE",
            "HIMA SEKHAR MIC COLLEGE",
            "HINDU COLLEGE",
            "INDIRA PRIYADARSHINI COLLEGE",
            "INTELL ENGINEERING COLLEGE",
            "JAGAN'S COLLEGE",
            "JAYA PRAKASH NARAYAN COLLEGE",
            "JNTUA COLLEGE",
            "JNTUH COLLEGE",
            "JOHNS COLLEGE",
            "JYOTHISHMATHI COLLEGE",
            "KAMAKSHI COLLEGE",
            "KANAKARAJU COLLEGE",
            "KAUSHIK COLLEGE",
            "KBR ENGINEERING COLLEGE",
            "KHADER MEMORIAL COLLEGE",
            "KIMS COLLEGE",
            "KITE COLLEGE",
            "KITE WOMEN'S COLLEGE",
            "KLR COLLEGE",
            "KOTTAM COLLEGE",
            "KSHATRIYA COLLEGE",
            "KUPPAM ENGINEERING COLLEGE",
            "LAKIREDDY BALI REDDY COLLEGE",
            "LENORA COLLEGE",
            "MADHIRA COLLEGE",
            "MADINA ENGINEERING COLLEGE",
            "MALLA REDDY COLLEGE",
            "MALLIKARJUNA RAO COLLEGE",
            "MARY'S ENGINEERING COLLEGE",
            "MATRUSRI ENGINEERING COLLEGE",
            "MEDAK COLLEGE",
            "MEDHA COLLEGE",
            "MEMORIAL COLLEGE",
            "MEMORIAL POLYTECHNIC COLLEGE",
            "MENTEY PADMANABHAM COLLEGE",
            "METHODIST COLLEGE",
            "MILITARY COLLEGE",
            "MJR COLLEGE",
            "MNR COLLEGE",
            "MOGHAL COLLEGE",
            "MOHMMEDENS COLLEGE",
            "MONA COLLEGE",
            "MOTHER THERESSA COLLEGE",
            "MUFFAKHAM JAH COLLEGE",
            "MUMTAZ COLLEGE",
            "MVR COLLEGE",
            "N COLLEGE",
            "NARAYANA ENGINEERING COLLEGE",
            "NAWAB SHAH ALAM KHAN COLLEGE",
            "NEW INDIA COLLEGE",
            "NEXUS COLLEGE",
            "NIGAMA ENGINEERING COLLEGE",
            "NIMRA COLLEGE",
            "NIMRA WOMEN'S COLLEGE",
            "NISHITHA COLLEGE",
            "NOBLE COLLEGE",
            "NOBLE POLYTECHNIC COLLEGE",
            "NOOR COLLEGE",
            "NOVA COLLEGE",
            "P COLLEGE",
            "PALADUGU PARVATHI DEVI COLLEGE",
            "PETER'S ENGINEERING COLLEGE",
            "PRAGATI ENGINEERING COLLEGE",
            "PRAKASAM ENGINEERING COLLEGE",
            "PRASAD ENGINEERING COLLEGE",
            "PRASIDDHA COLLEGE",
            "PRINCETON COLLEGE",
            "PRIYADARSHINI COLLEGE",
            "PUJYA SHRI MADHAVANJI COLLEGE",
            "PULLAIAH COLLEGE",
            "PYDAH COLLEGE",
            "QIS COLLEGE",
            "QUBA COLLEGE",
            "R & S COLLEGE",
            "RAGHU ENGINEERING COLLEGE",
            "RAJ COLLEGE",
            "RAJA MAHENDRA COLLEGE",
            "RAMA REDDY COLLEGE",
            "RAMACHANDRA COLLEGE",
            "RAMAPPA ENGINEERING COLLEGE",
            "RAVINDRA COLLEGE",
            "REDDY COLLEGE",
            "REDDY MEMORIAL COLLEGE",
            "RRS COLLEGE",
            "S COLLEGE",
            "S R ENGINEERING COLLEGE",
            "SAHASRA COLLEGE",
            "SAI SAKTHI ENGINEERING COLLEGE",
            "SAMSKRUTI COLLEGE",
            "SANA ENGINEERING COLLEGE",
            "SANKETIKA POLYTECHNIC COLLEGE",
            "SANTHIRAM ENGINEERING COLLEGE",
            "SHAAZ COLLEGE",
            "SHADAN COLLEGE",
            "SHADAN WOMEN'S COLLEGE",
            "SHAHJEHAN COLLEGE",
            "SHIVA RAMA KRISHNA COLLEGE",
            "SIR C R REDDY COLLEGE",
            "SKR COLLEGE",
            "SRADDAHA COLLEGE",
            "SREE CHAITANYA COLLEGE",
            "SREE RAMA ENGINEERING COLLEGE",
            "SREE VENKATESWARA COLLEGE",
            "SREENIVASA COLLEGE",
            "SRI ADITYA ENGINEERING COLLEGE",
            "SRI INDU COLLEGE",
            "SRI MITTAPALLI COLLEGE",
            "SRI PRAKASH COLLEGE",
            "SRI SAI COLLEGE",
            "SRI SATYA NARAYANA COLLEGE",
            "SRI SIVANI COLLEGE",
            "SRI SUNFLOWER COLLEGE",
            "SRI VAISHNAVI COLLEGE",
            "SRI VASAVI ENGINEERING COLLEGE",
            "SRI VENKATESA PERUMAL COLLEGE",
            "SRI VENKATESWARA COLLEGE",
            "SRI YPR COLLEGE",
            "SRR ENGINEERING COLLEGE",
            "SRUJANA COLLEGE",
            "STANLEY COLLEGE",
            "STANLEY STEPHEN COLLEGE",
            "SUBBA REDDY COLLEGE",
            "SUDHEER REDDY COLLEGE",
            "SUJANA COLLEGE",
            "SUPRABHATH COLLEGE",
            "SWARNA BHARATHI COLLEGE",
            "SWARNANDHRA COLLEGE",
            "SYED HASHIM COLLEGE",
            "TADIPATRI ENGINEERING COLLEGE",
            "TALLA PADMAVATHI COLLEGE",
            "TECHNOLOGY - COLLEGE",
            "TECHNOLOGY-COLLEGE",
            "TENALI ENGINEERING COLLEGE",
            "THE VAZIR SULTAN COLLEGE",
            "THE YOUNIS SULTAN COLLEGE",
            "TIRUMALA COLLEGE",
            "TIRUMALA ENGINEERING COLLEGE",
            "TKR COLLEGE",
            "TRAINING COLLEGE",
            "TRINITY COLLEGE",
            "TRR COLLEGE",
            "TRR ENGINEERING COLLEGE",
            "UNIVERSAL COLLEGE",
            "UNIVERSITY COLLEGE",
            "USHA RAMA COLLEGE",
            "VAAGDEVI COLLEGE",
            "VAAGDEVI ENGINEERING COLLEGE",
            "VAAGESWARI COLLEGE",
            "VARADHA REDDY COLLEGE",
            "VARDHAMAN COLLEGE",
            "VASAVI COLLEGE",
            "VELAGA NAGESWARA RAO COLLEGE",
            "VENKATESWARA HINDU COLLEGE",
            "VIF COLLEGE",
            "VIJAY COLLEGE",
            "VIJAYA ENGINEERING COLLEGE",
            "VIKAS COLLEGE",
            "VIKAS POLYTECHNIC COLLEGE",
            "VISAKA ENGINEERING COLLEGE",
            "VISHWA BHARATHI COLLEGE",
            "VISHWABHARATHI PG COLLEGE",
            "VISVESVARAYA COLLEGE",
            "VISVODAYA ENGINEERING COLLEGE",
            "VRK COLLEGE",
            "VRK WOMENS COLLEGE",
            "YALAMARTY COLLEGE"
        ];

        // In the register form submit handler in index.html
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const termsCheckbox = document.getElementById('acceptTerms');
            if (!termsCheckbox.checked) {
                Swal.fire({
                    title: 'Terms Not Accepted',
                    text: 'You must accept the Terms and Conditions to register',
                    icon: 'error',
                    confirmButtonColor: '#2563eb'
                });
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalButtonText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
                
            try {
                const formData = new FormData(this);
                const response = await fetch('/register', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Close the register modal
                    const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
                    if (registerModal) {
                        registerModal.hide();
                    }
                    
                    // Show success message with verification instructions
                    Swal.fire({
                        title: 'Registration Successful!',
                        text: 'Please check your email to verify your account before logging in.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                    
                    // Reset the form
                    this.reset();
                } else {
                    Swal.fire({
                        title: 'Registration Error',
                        text: data.error || 'Failed to register. Please try again.',
                        icon: 'error'
                    });
                }
            } catch (error) {
                console.error('Registration error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An unexpected error occurred. Please try again.',
                    icon: 'error'
                });
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalButtonText;
            }
        });
        // Function to toggle rent/sell fields
        function toggleRentFields() {
            const listingType = document.getElementById('listingType').value;
            const rentFields = document.querySelectorAll('.rent-field');
            const sellPriceField = document.getElementById('sellPriceField');
            
            if (listingType === 'rent') {
                // Show rent fields, hide sell price field
                rentFields.forEach(field => field.style.display = 'block');
                sellPriceField.style.display = 'none';
                
                // Make rent fields required, sell price not required
                document.querySelector('input[name="rent_price"]').required = true;
                document.querySelector('input[name="rent_tenure"]').required = true;
                document.querySelector('input[name="price"]').required = false;
            } else {
                // Hide rent fields, show sell price field
                rentFields.forEach(field => field.style.display = 'none');
                sellPriceField.style.display = 'block';
                
                // Make sell price required, rent fields not required
                document.querySelector('input[name="price"]').required = true;
                document.querySelector('input[name="rent_price"]').required = false;
                document.querySelector('input[name="rent_tenure"]').required = false;
            }
        }
        // Add to your existing JavaScript
        

        
        

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        const productTypes = {
            'electronic': ['Mobile', 'laptop','calci'],            'books': ['Text books', 'class book','running notes'],
            'clothes': ['Casual', 'Formal','Apron']
        };
        const categoryFields = {
            'electronic': {
                productTypes: ['Mobile', 'laptop', 'calci'],
                requiredFields: ['working_condition', 'warranty_status']
            },
            'books': {
                productTypes: ['Text books', 'class book', 'running notes'],
                requiredFields: ['subject', 'branch','softcopy']
            },
            'clothes': {
                productTypes: ['Casual', 'Formal', 'Apron'],
                requiredFields: []
            }
        };
        
        // Image preview handler
        document.querySelector('input[name="image"]').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.style.display = 'block';
                    preview.querySelector('img').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Category change handler
        document.getElementById('listingCategory').addEventListener('change', function() {
            const category = this.value;
            const productTypeSelect = document.getElementById('productType');
            
    // Show/hide fields based on category
            document.querySelector('.field-branch').style.display = category === 'books' ? 'block' : 'none';
            document.querySelector('.field-subject').style.display = category === 'books' ? 'block' : 'none';
            document.querySelector('.field-faculty').style.display = category === 'books' ? 'block' : 'none';
            document.querySelector('.field-softcopy').style.display = category === 'books' ? 'block' : 'none';
            
            // Update product types
            productTypeSelect.innerHTML = '<option value="">Select Product Type</option>';
            if (categoryFields[category]?.productTypes) {
                categoryFields[category].productTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.toLowerCase();
                    option.textContent = type;
                    productTypeSelect.appendChild(option);
                });
            }
            
            
            // Show/hide fields based on category
            const allFields = {
                'working_condition': document.querySelector('.field-working-condition'),
                'warranty_status': document.querySelector('.field-warranty'),
                'subject': document.querySelector('.field-subject'),
                'branch': document.querySelector('.field-branch')
            };
            
            // Hide all fields first
            Object.values(allFields).forEach(field => {
                if (field) {
                    field.style.display = 'none';
                    // Remove required attribute
                    const input = field.querySelector('input, select');
                    if (input) input.required = false;
                }
            });
            
            // Show required fields for selected category
            const requiredFields = categoryFields[category]?.requiredFields || [];
            requiredFields.forEach(fieldName => {
                const field = allFields[fieldName];
                if (field) {
                    field.style.display = 'block';
                    // Make the field required
                    const input = field.querySelector('input, select');
                    if (input) input.required = true;
                }
                if (fieldName === 'softcopy') {
                    document.querySelector('.field-softcopy').style.display = 'block';
                }
            });
        });
        function toggleFileUpload() {
            const isSoftCopy = document.getElementById('softCopy').checked;
            document.querySelector('.field-fileupload').style.display = isSoftCopy ? 'block' : 'none';
            if (isSoftCopy) {
                document.querySelector('input[name="document"]').required = true;
            } else {
                document.querySelector('input[name="document"]').required = false;
            }
        }
        
        // Modify the existing createListingForm submit handler
        // Modify the existing createListingForm submit handler
        document.getElementById('createListingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                if (!currentUser) {
                    throw new Error('You must be logged in to create a listing');
                }
                
                // Validate checkbox
                if (!this.querySelector('[name="is_fake_warning"]').checked) {
                    throw new Error('You must confirm that the product is genuine');
                }
                
                const category = this.querySelector('[name="category"]').value;
                const listingType = this.querySelector('[name="listing_type"]').value;
                const formData = new FormData(this);
                
                // Set is_for_rent based on listing type
                formData.append('is_for_rent', listingType === 'rent' ? 'true' : 'false');
                
                // If it's a rental listing, ensure price is set to 0 or a minimal value
                if (listingType === 'rent') {
                    formData.set('price', '0');
                }
                
                // Make sure study_year is included
                const academicYear = document.getElementById('academicYear').value;
                if (academicYear) {
                    formData.set('study_year', academicYear);
                }
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
                
                const response = await fetch('/create-listing', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createListingModal'));
                    modal.hide();
                    
                    // Show success message
                    await Swal.fire({
                        title: 'Success!',
                        text: 'Your listing has been created successfully',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Reset form
                    this.reset();
                    document.getElementById('imagePreview').style.display = 'none';
                    
                    // Force redirect to buy page
                    handlePathSelection('buy');
                    
                } else {
                    throw new Error(data.error || 'Failed to create listing');
                }
            } catch (error) {
                console.error('Error creating listing:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message,
                    icon: 'error'
                });
            } finally {
                // Reset button state
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Create Listing';
                }
            }
        });
        function showLoading() {
            document.getElementById('loadingSkeleton').style.display = 'flex';
            document.getElementById('listingsGrid').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loadingSkeleton').style.display = 'none';
            document.getElementById('listingsGrid').style.display = 'flex';
        }
        
        // Alert function (if not already defined)
        function showAlert(title, text, icon) {
            Swal.fire({
                title,
                text,
                icon,
                confirmButtonColor: '#2563eb'
            });
        }
        // Chat Management
        // Chat Management
        // Global variables
        // Global variables
        let currentChatUser = null;
        let chatMessages = {};

        // Function to initialize chat interface
        function initializeChat() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendMessage');
            const currentUserName = document.getElementById('currentUserName');

            // Set current user name if available
            if (currentUser && currentUser.full_name) {
                currentUserName.textContent = currentUser.full_name;
            }

            // Handle send message
            sendButton.addEventListener('click', () => sendMessage());
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Load initial chats
            loadChats();
        }

        // Function to load all chats
        async function loadChats() {
            try {
                const response = await fetch('/api/messages', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to load chats');
                
                const data = await response.json();
                const chatList = document.getElementById('chatList');
                chatList.innerHTML = '';

                if (data.messages && data.messages.length > 0) {
                    // Group messages by conversation
                    const conversations = groupMessagesByConversation(data.messages);
                    
                    // Render each conversation in the sidebar
                    conversations.forEach(conv => {
                        const lastMessage = conv.messages[conv.messages.length - 1];
                        const otherUser = lastMessage.sender_id === currentUser.id ? 
                            lastMessage.receiver : lastMessage.sender;

                        const chatItem = createChatListItem(otherUser, lastMessage);
                        chatList.appendChild(chatItem);
                    });
                } else {
                    // Show empty state
                    chatList.innerHTML = `
                        <div class="text-center text-muted p-3">
                            <i class="fas fa-comments fa-2x mb-2"></i>
                            <p>No conversations yet</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading chats:', error);
                showAlert('Error', error.message, 'error');
            }
        }

        // Function to group messages by conversation
        function groupMessagesByConversation(messages) {
            const conversations = {};
            
            messages.forEach(message => {
                const conversationId = [message.sender_id, message.receiver_id].sort().join('-');
                
                if (!conversations[conversationId]) {
                    conversations[conversationId] = {
                        messages: [],
                        otherUserId: message.sender_id === currentUser.id ? 
                            message.receiver_id : message.sender_id
                    };
                }
                conversations[conversationId].messages.push(message);
            });

            return Object.values(conversations);
        }

        // Function to create a chat list item
        function createChatListItem(user, lastMessage) {
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="user-avatar me-3">
                        <img src="${user.profile_picture || 'https://via.placeholder.com/40'}" 
                            class="rounded-circle" alt="${user.full_name}">
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${user.full_name}</h6>
                        <p class="mb-0 text-muted small text-truncate">${lastMessage.content}</p>
                    </div>
                    <div class="text-muted small">
                        ${formatMessageTime(lastMessage.created_at)}
                    </div>
                </div>
            `;

            div.addEventListener('click', () => {
                // Remove active class from all chat items
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active class to clicked item
                div.classList.add('active');
                
                // Open the chat
                openChat(user, lastMessage.listing_id);
            });

            return div;
        }

        // Function to open a chat
// Function to open a chat
        function openChat(user, listingId) {
            currentChatUser = {
                id: user.id,
                listing_id: listingId,
                full_name: user.full_name
            };
            
            // Hide empty state and show chat content
            const emptyState = document.querySelector('.chat-empty-state');
            const chatContent = document.getElementById('chatContent');
            
            // Properly hide empty state and show chat content
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            chatContent.style.display = 'flex'; // Change to flex instead of removing d-none
            chatContent.classList.remove('d-none');
            
            // Update chat header
            document.getElementById('chatContactName').textContent = user.full_name;
            if (user.profile_picture) {
                document.getElementById('chatContactAvatar').src = user.profile_picture;
            }
            
            // Enable message input and focus it
            const messageInput = document.getElementById('messageInput');
            messageInput.disabled = false;
            messageInput.value = ''; // Clear any existing text
            messageInput.focus();
            
            // Load chat messages
            loadChatMessages(user.id, listingId);
            
            // Add scroll button
            addScrollButton();

            // Update active chat in sidebar
            updateActiveChatInSidebar(user.id);
        }

        // Add this new function to handle sidebar active state
        function updateActiveChatInSidebar(userId) {
            // Remove active class from all chat items
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to the selected chat
            const selectedChat = document.querySelector(`[data-user-id="${userId}"]`);
            if (selectedChat) {
                selectedChat.classList.add('active');
            }
        }

        // Function to load chat messages
        async function loadChatMessages(userId, listingId) {
            try {
                const response = await fetch(`/api/messages?other_user_id=${userId}&listing_id=${listingId}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load messages');
                }
                
                const data = await response.json();
                
                // Remove duplicates and sort messages
                const uniqueMessages = Array.from(
                    new Map(data.messages.map(item => [item.id, item])).values()
                ).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                
                displayMessages(uniqueMessages);
                
            } catch (error) {
                console.error('Error loading messages:', error);
                showAlert('Error', error.message, 'error');
            }
        }

        // Function to display messages
        function displayMessages(messages) {
            const chatMessages = document.getElementById('chatMessages');
            const messageContainer = document.querySelector('.message-container');
            messageContainer.innerHTML = '';
            
            // Store current scroll position and total height
            const wasScrolledToBottom = chatMessages.scrollHeight - chatMessages.scrollTop === chatMessages.clientHeight;
            
            messages.forEach(message => {
                const messageElement = createMessageElement(message);
                messageContainer.appendChild(messageElement);
            });
            
            // Scroll handling
            if (wasScrolledToBottom) {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }
        }

        // Function to create a message element
        function createMessageElement(message) {
            const div = document.createElement('div');
            const isSent = parseInt(message.sender_id) === parseInt(currentUser.id);
            div.className = `message ${isSent ? 'sent' : 'received'}`;
            
            div.innerHTML = `
                <div class="message-content">${message.content}</div>
                <div class="message-time">
                    ${formatMessageTime(message.created_at)}
                    ${isSent ? `<i class="fas fa-check-double ${message.read ? 'text-primary' : ''}"></i>` : ''}
                </div>
            `;
            
            return div;
        }

        // Function to send a message
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content || !currentChatUser) return;
            
            const sendButton = document.getElementById('sendMessage');
            sendButton.disabled = true;
            
            try {
                const response = await fetch('/api/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receiver_id: currentChatUser.id,
                        listing_id: currentChatUser.listing_id,
                        content: content
                    }),
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to send message');
                }

                // Clear input
                messageInput.value = '';
                messageInput.focus();
                
                // Refresh messages
                await loadChatMessages(currentChatUser.id, currentChatUser.listing_id);
                
                // Scroll to bottom
                scrollToBottom();
                
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Error', error.message, 'error');
            } finally {
                sendButton.disabled = false;
            }
        }

        // Function to scroll to bottom
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to add scroll button
        function addScrollButton() {
            let scrollButton = document.getElementById('scrollBottom');
            if (!scrollButton) {
                scrollButton = document.createElement('button');
                scrollButton.id = 'scrollBottom';
                scrollButton.className = 'btn btn-primary btn-sm rounded-circle position-absolute';
                scrollButton.innerHTML = '<i class="fas fa-arrow-down"></i>';
                scrollButton.onclick = scrollToBottom;
                document.querySelector('.chat-window').appendChild(scrollButton);
            }
            
            // Show/hide scroll button based on scroll position
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.addEventListener('scroll', () => {
                const isScrolledToBottom = 
                    Math.abs(chatMessages.scrollHeight - chatMessages.scrollTop - chatMessages.clientHeight) < 10;
                scrollButton.style.display = isScrolledToBottom ? 'none' : 'block';
            });
        }

        // Utility function to format message time
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString();
            }
        }

        // Function to show alert messages
        function showAlert(title, message, type = 'info') {
            // You can implement your own alert system here
            console.log(`${title}: ${message}`);
        }

        // Message input handler
        document.getElementById('messageInput').addEventListener('input', function() {
            const sendButton = document.getElementById('sendMessage');
            sendButton.disabled = !this.value.trim();
        });

        // Initialize chat when modal is shown
        document.getElementById('chatModal').addEventListener('show.bs.modal', () => {
            // Reset chat window to empty state
            document.querySelector('.chat-empty-state').style.display = 'flex';
            document.getElementById('chatContent').classList.add('d-none');
            
            // Disable message input initially
            document.getElementById('messageInput').disabled = true;
            
            // Initialize chat
            initializeChat();
        });

        // Search functionality
        document.getElementById('chatSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const userName = item.querySelector('h6').textContent.toLowerCase();
                const lastMessage = item.querySelector('p').textContent.toLowerCase();
                
                if (userName.includes(searchTerm) || lastMessage.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Function to show messages modal
        function showMessages() {
            const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
            chatModal.show();
        }
        // Add this to your DOMContentLoaded event listener
        const urlParams = new URLSearchParams(window.location.search);
        const verificationStatus = urlParams.get('verification');

        if (verificationStatus === 'success') {
            showAlert('Email Verified', 'You can now login!', 'success');
            // Clear the query parameter
            window.history.replaceState({}, document.title, window.location.pathname);
        } else if (verificationStatus === 'invalid') {
            showAlert('Invalid Token', 'The verification link is invalid', 'error');
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // Messaging System

        // Enhanced JavaScript functionality

        // Add this at the start of your JavaScript

        // Email verification handling
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const action = urlParams.get('action');

            // Handle verification callback
            if (token && action === 'verify') {
                // Call the verification API
                fetch(`/verify-email/${token}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            Swal.fire({
                                title: 'Email Verified!',
                                text: 'Your email has been verified successfully. You can now log in.',
                                icon: 'success',
                                confirmButtonText: 'Login Now'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // Open login modal
                                    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                                    loginModal.show();
                                }
                            });
                        } else {
                            Swal.fire({
                                title: 'Verification Failed',
                                text: data.error || 'There was a problem verifying your email.',
                                icon: 'error'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Verification error:', error);
                        Swal.fire({
                            title: 'Verification Error',
                            text: 'An unexpected error occurred during verification.',
                            icon: 'error'
                        });
                    });
                
                // Clear the query parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Add this function to check for new messages periodically
        function startMessageChecking() {
            let lastMessageTime = new Date().toISOString();
            
            setInterval(async () => {
                if (!currentUser) return;
                
                try {
                    const response = await fetch(`/api/messages/check-new?since=${lastMessageTime}`, {
                        credentials: 'same-origin'
                    });
                    
                    if (!response.ok) throw new Error('Failed to check messages');
                    
                    const data = await response.json();
                    
                    if (data.messages && data.messages.length > 0) {
                        // Update last message time
                        lastMessageTime = new Date().toISOString();
                        
                        // Show notification for each new message
                        data.messages.forEach(message => {
                            Swal.fire({
                                title: 'New Message',
                                html: `
                                    <p><strong>From:</strong> ${message.sender.full_name}</p>
                                    <p><strong>About:</strong> ${message.listing.title}</p>
                                    <p>${message.content}</p>
                                `,
                                icon: 'info',
                                showCancelButton: true,
                                confirmButtonText: 'Reply',
                                cancelButtonText: 'Later'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    showMessages();
                                    // Open the specific chat
                                    setTimeout(() => {
                                        openChat(message.sender, message.listing_id);
                                    }, 500);
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error checking messages:', error);
                }
            }, 10000); // Check every 10 seconds
        }

        // Add this to your login success handler
        if (response.ok) {
            // ... existing login success code ...
            startMessageChecking(); // Start checking for new messages
        }

        // Add these new functions for editing and deleting listings
        

        async function deleteListing(listingId) {
            try {
                const result = await Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`/api/listings/${listingId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });

                    if (!response.ok) throw new Error('Failed to delete listing');

                    showAlert('Success', 'Listing deleted successfully', 'success');
                    
                    // Reload the page after deletion
                    if (window.location.pathname === '/my-listings') {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                }
            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }

        // Update the wishlist link/button click handler
        

        // Add this new function to initialize the wishlist page
        
        // At the bottom of your script, add:
        window.addEventListener('load', function() {
            // If admin modal exists and user is admin, show it
            const adminModalEl = document.getElementById('adminDashboardModal');
            if (adminModalEl && localStorage.getItem('isAdmin') === 'true' && currentUser && currentUser.is_admin) {
                const adminModal = new bootstrap.Modal(adminModalEl);
                adminModal.show();
                loadAdminData();
            } else if (localStorage.getItem('isAdmin') === 'true' && (!currentUser || !currentUser.is_admin)) {
                // If localStorage has admin flag but user isn't admin, clear it
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminDashboardOpen');
            }
        });
        // Admin Dashboard Main Functions
        function showAdminDashboard() {
            // Stricter admin check - require both localStorage AND current user to be admin
            // This prevents non-admin users from accessing admin features
            if (!currentUser || !currentUser.is_admin) {
                // Clear any admin status in localStorage to be safe
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminDashboardOpen');
                showAlert('Access Denied', 'You must be an admin to access this page', 'error');
                return;
            }
            
            // Store that admin dashboard is open
            localStorage.setItem('adminDashboardOpen', 'true');

            const adminModal = new bootstrap.Modal(document.getElementById('adminDashboardModal'));
            adminModal.show();
            loadAdminData();
            
            // Store admin status in localStorage
            localStorage.setItem('isAdmin', 'true');
        }
        // Alert Utility Function
        function showAlert(title, message, type = 'info') {
            const alertPlaceholder = document.getElementById('alertsContainer');
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <strong>${title}:</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertPlaceholder.append(wrapper);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const alert = bootstrap.Alert.getInstance(wrapper.querySelector('.alert'));
                if (alert) {
                    alert.close();
                } else {
                    wrapper.querySelector('.alert').remove();
                }
            }, 5000);
        }

        // User Management
        let currentUserPage = 1;
        const usersPerPage = 10;

        async function adminDeleteUser(userId) {
            try {
                const result = await Swal.fire({
                    title: 'Are you sure?',
                    text: "This will delete the user and all their listings!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                });

                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deleting...',
                        text: 'Please wait while we delete the user and their listings',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    const response = await fetch(`/admin/delete-user/${userId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete user');
                    }
                    
                    const data = await response.json();
                    
                    Swal.fire({
                        title: 'Success!',
                        text: data.message || 'User and their listings deleted successfully',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Reload admin data to refresh the UI
                    setTimeout(() => {
                        loadAdminData();
                    }, 500);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to delete user',
                    icon: 'error'
                });
            }
        }

        async function adminToggleVerification(userId, isVerified) {
            try {
                const response = await fetch(`/admin/toggle-verification/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to update verification status');
                
                const data = await response.json();
                showAlert('Success', data.message, 'success');
                
            } catch (error) {
                showAlert('Error', error.message, 'error');
                // Revert the toggle if there was an error
                document.querySelector(`.toggle-verification[data-user-id="${userId}"]`).checked = !isVerified;
            }
        }

        async function showUserDetails(userId) {
            try {
                const response = await fetch(`/admin/user-details/${userId}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to load user details');
                
                const user = await response.json();
                
                // Format the user details HTML
                const userDetailsHtml = `
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            ${user.profile_picture ? 
                                `<img src="/static/${user.profile_picture}" class="img-fluid rounded-circle" alt="Profile" style="max-height: 200px;">` : 
                                `<i class="fas fa-user-circle fa-5x text-muted"></i>`}
                        </div>
                        <div class="col-md-8">
                            <h4>${user.full_name || 'N/A'}</h4>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>College:</strong> ${user.college || 'N/A'}</p>
                            <p><strong>Department:</strong> ${user.department || 'N/A'}</p>
                            <p><strong>Year:</strong> ${user.year || 'N/A'}</p>
                            <p><strong>Registered:</strong> ${new Date(user.created_at).toLocaleString()}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge ${user.is_verified ? 'bg-success' : 'bg-warning'}">
                                    ${user.is_verified ? 'Verified' : 'Unverified'}
                                </span>
                            </p>
                            <p><strong>Listings Count:</strong> ${user.listings_count || 0}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>User's Listings</h5>
                        <div class="row" id="userListingsContainer">
                            <!-- Listings will be loaded here -->
                        </div>
                    </div>
                `;
                
                // Set the content and show the modal
                document.getElementById('userDetailsContent').innerHTML = userDetailsHtml;
                const userDetailsModal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                userDetailsModal.show();
                
                // Load user's listings
                loadUserListings(userId);
                
            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }

        async function loadUserListings(userId) {
            try {
                const response = await fetch(`/admin/user-listings/${userId}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to load user listings');
                
                const listings = await response.json();
                const container = document.getElementById('userListingsContainer');
                
                if (listings.length === 0) {
                    container.innerHTML = '<div class="col-12 text-muted">No listings found</div>';
                    return;
                }
                
                container.innerHTML = listings.map(listing => `
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <img src="/static/${listing.image_url}" class="card-img-top" alt="${listing.title}" style="height: 150px; object-fit: cover;">
                            <div class="card-body">
                                <h6 class="card-title">${listing.title}</h6>
                                <p class="card-text">?${listing.price}</p>
                                <button class="btn btn-sm btn-primary" onclick="showListingDetails(${listing.id})">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading user listings:', error);
            }
        }

        async function loadAdminUsers(page = 1, search = '', filter = '') {
            try {
                const response = await fetch(`/admin/dashboard?page=${page}&search=${search}&filter=${filter}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to load users');
                
                const data = await response.json();
                const usersTable = document.getElementById('usersTableBody');
                usersTable.innerHTML = data.users.map(user => `
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}">
                        </td>
                        <td>${user.id}</td>
                        <td>
                            <a href="#" onclick="showUserDetails(${user.id})">${user.full_name || 'N/A'}</a>
                        </td>
                        <td>${user.email}</td>
                        <td>${user.college || 'N/A'}</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input toggle-verification" type="checkbox" 
                                    data-user-id="${user.id}" ${user.is_verified ? 'checked' : ''}>
                            </div>
                        </td>
                        <td>${user.listings_count}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="adminDeleteUser(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                // Update pagination info
                const totalUsers = data.stats.total_users;
                const start = (page - 1) * usersPerPage + 1;
                const end = Math.min(page * usersPerPage, totalUsers);
                
                document.getElementById('userStart').textContent = start;
                document.getElementById('userEnd').textContent = end;
                document.getElementById('userTotal').textContent = totalUsers;
                
                // Update pagination buttons
                document.getElementById('userPrevPage').disabled = page <= 1;
                document.getElementById('userNextPage').disabled = end >= totalUsers;
                
                currentUserPage = page;
                
                // Add event listeners for verification toggles
                document.querySelectorAll('.toggle-verification').forEach(toggle => {
                    toggle.addEventListener('change', function() {
                        adminToggleVerification(this.dataset.userId, this.checked);
                    });
                });
                
            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }

        // Listing Management
        let currentListingPage = 1;
        const listingsPerPage = 10;

        async function adminDeleteListing(listingId) {
            try {
                const result = await Swal.fire({
                    title: 'Are you sure?',
                    text: "This will permanently delete the listing!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                });

                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deleting...',
                        text: 'Please wait while we delete the listing',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    const response = await fetch(`/admin/delete-listing/${listingId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to delete listing');
                    }
                    
                    const data = await response.json();
                    
                    Swal.fire({
                        title: 'Success!',
                        text: data.message || 'Listing deleted successfully',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Reload admin data to refresh the UI
                    setTimeout(() => {
                        loadAdminData();
                    }, 500);
                }
            } catch (error) {
                console.error('Error deleting listing:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to delete listing',
                    icon: 'error'
                });
            }
        }

        async function adminToggleFakeWarning(listingId, isFakeWarning) {
            try {
                const response = await fetch(`/admin/toggle-fake-warning/${listingId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to update fake warning status');
                
                const data = await response.json();
                showAlert('Success', data.message, 'success');
                
            } catch (error) {
                showAlert('Error', error.message, 'error');
                // Revert the toggle if there was an error
                document.querySelector(`.toggle-fake-warning[data-listing-id="${listingId}"]`).checked = !isFakeWarning;
            }
        }

        async function showListingDetails(listingId) {
            try {
                const response = await fetch(`/admin/listing-details/${listingId}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to load listing details');
                
                const listing = await response.json();
                
                // Format the listing details HTML
                const listingDetailsHtml = `
                    <div class="row">
                        <div class="col-md-5">
                            <img src="/static/${listing.image_url}" class="img-fluid rounded" alt="${listing.title}">
                        </div>
                        <div class="col-md-7">
                            <h3>${listing.title}</h3>
                            <p class="text-muted">Posted by: ${listing.seller.full_name} (ID: ${listing.seller_id})</p>
                            <p><strong>Price:</strong> ?${listing.price}</p>
                            ${listing.rent_price ? `<p><strong>Rent Price:</strong> ?${listing.rent_price}</p>` : ''}
                            <p><strong>Category:</strong> ${listing.category}</p>
                            <p><strong>Condition:</strong> ${listing.condition}</p>
                            <p><strong>Posted:</strong> ${new Date(listing.created_at).toLocaleString()}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge ${listing.is_fake_warning ? 'bg-danger' : 'bg-success'}">
                                    ${listing.is_fake_warning ? 'Marked as suspicious' : 'Verified'}
                                </span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Description</h5>
                        <p>${listing.description}</p>
                        
                        ${listing.product_type ? `<p><strong>Product Type:</strong> ${listing.product_type}</p>` : ''}
                        ${listing.branch ? `<p><strong>Branch:</strong> ${listing.branch}</p>` : ''}
                        ${listing.study_year ? `<p><strong>Study Year:</strong> ${listing.study_year}</p>` : ''}
                        ${listing.working_condition ? `<p><strong>Working Condition:</strong> ${listing.working_condition}</p>` : ''}
                        ${listing.warranty_status ? `<p><strong>Warranty Status:</strong> ${listing.warranty_status}</p>` : ''}
                        ${listing.subject ? `<p><strong>Subject:</strong> ${listing.subject}</p>` : ''}
                    </div>
                `;
                
                // Set the content and show the modal
                document.getElementById('listingDetailsContent').innerHTML = listingDetailsHtml;
                const listingDetailsModal = new bootstrap.Modal(document.getElementById('listingDetailsModal'));
                listingDetailsModal.show();
                
            } catch (error) {
                showAlert('Error', error.message, 'error');
            }
        }

        async function loadAdminListings(page = 1, search = '', filter = '') {
            try {
                const response = await fetch(`/admin/dashboard?page=${page}&search=${search}&filter=${filter}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to load listings');
                
                const data = await response.json();
                const listingsTable = document.getElementById('listingsTableBody');
                
                if (!data.listings || data.listings.length === 0) {
                    listingsTable.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-3">No listings found</td>
                        </tr>
                    `;
                    return;
                }
                
                listingsTable.innerHTML = data.listings.map(listing => `
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input listing-checkbox" value="${listing.id}">
                        </td>
                        <td>${listing.id}</td>
                        <td>
                            <a href="#" onclick="showListingDetails(${listing.id})">${listing.title}</a>
                        </td>
                        <td>?${listing.price}</td>
                        <td>${listing.category}</td>
                        <td>${listing.seller_name}</td>
                        <td>
                            <span class="badge ${listing.is_fake_warning ? 'bg-danger' : 'bg-success'}">
                                ${listing.is_fake_warning ? 'Flagged' : 'Clean'}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="showListingDetails(${listing.id})" 
                                    title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="adminToggleFakeWarning(${listing.id}, ${!listing.is_fake_warning})" 
                                    title="${listing.is_fake_warning ? 'Remove Flag' : 'Flag as Fake'}">
                                    <i class="fas fa-flag"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="adminDeleteListing(${listing.id})" 
                                    title="Delete Listing">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                // Update pagination info
                const totalListings = data.stats.total_listings;
                const start = (page - 1) * listingsPerPage + 1;
                const end = Math.min(page * listingsPerPage, totalListings);
                
                document.getElementById('listingStart').textContent = start;
                document.getElementById('listingEnd').textContent = end;
                document.getElementById('listingTotal').textContent = totalListings;
                
                // Update pagination buttons
                document.getElementById('listingPrevPage').disabled = page <= 1;
                document.getElementById('listingNextPage').disabled = end >= totalListings;
                
                currentListingPage = page;
                
            } catch (error) {
                console.error('Error loading listings:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to load listings',
                    icon: 'error'
                });
            }
        }
        
        // Toggle fake warning flag on a listing
        async function adminToggleFakeWarning(listingId, setFlagged) {
            try {
                Swal.fire({
                    title: 'Updating...',
                    text: `${setFlagged ? 'Flagging' : 'Unflagging'} listing`,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                const response = await fetch(`/admin/toggle-fake-warning/${listingId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update fake warning status');
                }
                
                const data = await response.json();
                
                Swal.fire({
                    title: 'Success!',
                    text: data.message || 'Listing status updated successfully',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Refresh listings
                loadAdminListings(currentListingPage);
                
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: error.message,
                    icon: 'error'
                });
            }
        }

        // Charts and Statistics
        function initCharts() {
            // Load Chart.js from CDN if not already loaded
            if (typeof Chart === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = renderCharts;
                document.head.appendChild(script);
            } else {
                renderCharts();
            }
        }

        function renderCharts() {
            fetch('/admin/stats', {
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load chart data');
                }
                return response.json();
            })
            .then(data => {
                try {
                    // User Growth Chart
                    const userGrowthCtx = document.getElementById('userGrowthChart');
                    if (userGrowthCtx && data.user_growth && data.user_growth.length > 0) {
                        new Chart(userGrowthCtx.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: data.user_growth.map(item => item.date),
                                datasets: [{
                                    label: 'New Users',
                                    data: data.user_growth.map(item => item.count),
                                    backgroundColor: 'rgba(37, 99, 235, 0.2)',
                                    borderColor: 'rgba(37, 99, 235, 1)',
                                    borderWidth: 2,
                                    tension: 0.3,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0
                                        }
                                    }
                                }
                            }
                        });
                    }

                    // Listing Growth Chart
                    const listingGrowthCtx = document.getElementById('listingGrowthChart');
                    if (listingGrowthCtx && data.listing_growth && data.listing_growth.length > 0) {
                        new Chart(listingGrowthCtx.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: data.listing_growth.map(item => item.date),
                                datasets: [{
                                    label: 'New Listings',
                                    data: data.listing_growth.map(item => item.count),
                                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                    borderColor: 'rgba(16, 185, 129, 1)',
                                    borderWidth: 2,
                                    tension: 0.3,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            precision: 0
                                        }
                                    }
                                }
                            }
                        });
                    }

                    // Category Distribution Chart
                    const categoryCtx = document.getElementById('categoryChart');
                    if (categoryCtx && data.category_distribution && data.category_distribution.length > 0) {
                        const categories = data.category_distribution.map(item => item.category);
                        const counts = data.category_distribution.map(item => item.count);
                        
                        new Chart(categoryCtx.getContext('2d'), {
                            type: 'doughnut',
                            data: {
                                labels: categories,
                                datasets: [{
                                    data: counts,
                                    backgroundColor: [
                                        'rgba(37, 99, 235, 0.7)',
                                        'rgba(16, 185, 129, 0.7)',
                                        'rgba(245, 158, 11, 0.7)',
                                        'rgba(239, 68, 68, 0.7)',
                                        'rgba(139, 92, 246, 0.7)',
                                        'rgba(236, 72, 153, 0.7)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'right'
                                    }
                                }
                            }
                        });
                    }
                    
                    // College Distribution Chart is skipped as the data is not available yet
                } catch (error) {
                    console.error('Error rendering charts:', error);
                }
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
        }

        // Main Data Loader
        async function loadAdminData() {
            try {
                // Load stats first
                const statsResponse = await fetch('/admin/dashboard', {
                    credentials: 'same-origin'
                });
                
                if (!statsResponse.ok) {
                    const errorData = await statsResponse.json();
                    throw new Error(errorData.error || 'Failed to load admin data');
                }
                
                const data = await statsResponse.json();
                
                // Update stats
                if (data && data.stats) {
                    document.getElementById('totalUsers').textContent = data.stats.total_users || 0;
                    document.getElementById('verifiedUsers').textContent = data.stats.verified_users || 0;
                    document.getElementById('unverifiedUsers').textContent = 
                        (data.stats.total_users || 0) - (data.stats.verified_users || 0);
                    document.getElementById('totalListings').textContent = data.stats.total_listings || 0;
                    document.getElementById('fakeWarnings').textContent = data.stats.fake_warnings || 0;
                    
                    // Update reports badge
                    if (data.stats.pending_reports) {
                        document.getElementById('reportsBadge').textContent = data.stats.pending_reports;
                        document.getElementById('reportsBadge').style.display = 'inline-block';
                    } else {
                        document.getElementById('reportsBadge').style.display = 'none';
                    }
                }
                
                // Initialize charts
                try {
                    initCharts();
                } catch (chartError) {
                    console.error('Error initializing charts:', chartError);
                }
                
                // Load users if available
                if (data && data.users) {
                    // Populate users table
                    const usersTable = document.getElementById('usersTableBody');
                    usersTable.innerHTML = data.users.map(user => `
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}">
                            </td>
                            <td>${user.id}</td>
                            <td>
                                <a href="#" onclick="showUserDetails(${user.id})">${user.full_name || 'N/A'}</a>
                            </td>
                            <td>${user.email}</td>
                            <td>${user.college || 'N/A'}</td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input toggle-verification" type="checkbox" 
                                        data-user-id="${user.id}" ${user.is_verified ? 'checked' : ''}>
                                </div>
                            </td>
                            <td>${user.listings_count || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="adminDeleteUser(${user.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                    // Add event listeners for verification toggles
                    document.querySelectorAll('.toggle-verification').forEach(toggle => {
                        toggle.addEventListener('change', function() {
                            adminToggleVerification(this.dataset.userId, this.checked);
                        });
                    });
                } else {
                    // If data doesn't include users, load them separately
                    loadAdminUsers();
                }
                
                // Load listings if available
                if (data && data.listings) {
                    // Populate listings table
                    const listingsTable = document.getElementById('listingsTableBody');
                    listingsTable.innerHTML = data.listings.map(listing => `
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input listing-checkbox" value="${listing.id}">
                            </td>
                            <td>${listing.id}</td>
                            <td>
                                <a href="#" onclick="showListingDetails(${listing.id})">${listing.title}</a>
                            </td>
                            <td>?${listing.price}</td>
                            <td>${listing.category}</td>
                            <td>${listing.seller_name}</td>
                            <td>
                                <span class="badge ${listing.is_fake_warning ? 'bg-danger' : 'bg-success'}">
                                    ${listing.is_fake_warning ? 'Flagged' : 'Clean'}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="showListingDetails(${listing.id})" 
                                        title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="adminToggleFakeWarning(${listing.id}, ${!listing.is_fake_warning})" 
                                        title="${listing.is_fake_warning ? 'Remove Flag' : 'Flag as Fake'}">
                                        <i class="fas fa-flag"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="adminDeleteListing(${listing.id})" 
                                        title="Delete Listing">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    // If data doesn't include listings, load them separately
                    loadAdminListings();
                }
                
                // Load reports if available
                if (data && data.reports) {
                    populateReportsTable(data.reports);
                }
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to load admin dashboard data',
                    icon: 'error'
                });
            }
        }

        // Search and Filter Functions
        function searchUsers() {
            const searchTerm = document.getElementById('userSearchInput').value;
            const filterValue = document.getElementById('userFilterSelect').value;
            loadAdminUsers(1, searchTerm, filterValue);
        }

        function searchListings() {
            const searchTerm = document.getElementById('listingSearchInput').value;
            const filterValue = document.getElementById('listingFilterSelect').value;
            loadAdminListings(1, searchTerm, filterValue);
        }

        // Pagination Handlers
        function userPrevPage() {
            if (currentUserPage > 1) {
                const searchTerm = document.getElementById('userSearchInput').value;
                const filterValue = document.getElementById('userFilterSelect').value;
                loadAdminUsers(currentUserPage - 1, searchTerm, filterValue);
            }
        }

        function userNextPage() {
            const searchTerm = document.getElementById('userSearchInput').value;
            const filterValue = document.getElementById('userFilterSelect').value;
            loadAdminUsers(currentUserPage + 1, searchTerm, filterValue);
        }

        function listingPrevPage() {
            if (currentListingPage > 1) {
                const searchTerm = document.getElementById('listingSearchInput').value;
                const filterValue = document.getElementById('listingFilterSelect').value;
                loadAdminListings(currentListingPage - 1, searchTerm, filterValue);
            }
        }

        function listingNextPage() {
            const searchTerm = document.getElementById('listingSearchInput').value;
            const filterValue = document.getElementById('listingFilterSelect').value;
            loadAdminListings(currentListingPage + 1, searchTerm, filterValue);
        }

        // Bulk Actions
        function bulkDeleteUsers() {
            const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
            
            if (selectedUsers.length === 0) {
                showAlert('Warning', 'No users selected', 'warning');
                return;
            }
            
            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete ${selectedUsers.length} users and their listings! This cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete them!'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deleting...',
                        text: 'Please wait while we delete the users',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    let completedRequests = 0;
                    let failedRequests = 0;
                    
                    selectedUsers.forEach(userId => {
                        fetch(`/admin/delete-user/${userId}`, {
                            method: 'DELETE',
                            credentials: 'same-origin'
                        })
                        .then(response => {
                            if (response.ok) {
                                completedRequests++;
                            } else {
                                failedRequests++;
                            }
                            
                            // Check if all requests are done
                            if (completedRequests + failedRequests === selectedUsers.length) {
                                if (failedRequests === 0) {
                                    Swal.fire({
                                        title: 'Success!',
                                        text: `${completedRequests} users deleted successfully`,
                                        icon: 'success',
                                        timer: 2000,
                                        showConfirmButton: false
                                    });
                                } else {
                                    Swal.fire({
                                        title: 'Partial Success',
                                        text: `${completedRequests} users deleted successfully, ${failedRequests} failed`,
                                        icon: 'warning'
                                    });
                                }
                                
                                // Reload the admin data
                                loadAdminData();
                            }
                        })
                        .catch(error => {
                            failedRequests++;
                            
                            // Check if all requests are done
                            if (completedRequests + failedRequests === selectedUsers.length) {
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Some or all user deletions failed',
                                    icon: 'error'
                                });
                                
                                // Reload the admin data
                                loadAdminData();
                            }
                        });
                    });
                }
            });
        }

        function bulkDeleteListings() {
            const selectedListings = Array.from(document.querySelectorAll('.listing-checkbox:checked')).map(cb => cb.value);
            
            if (selectedListings.length === 0) {
                showAlert('Warning', 'No listings selected', 'warning');
                return;
            }
            
            Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete ${selectedListings.length} listings! This cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete them!'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deleting...',
                        text: 'Please wait while we delete the listings',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    
                    let completedRequests = 0;
                    let failedRequests = 0;
                    
                    selectedListings.forEach(listingId => {
                        fetch(`/admin/delete-listing/${listingId}`, {
                            method: 'DELETE',
                            credentials: 'same-origin'
                        })
                        .then(response => {
                            if (response.ok) {
                                completedRequests++;
                            } else {
                                failedRequests++;
                            }
                            
                            // Check if all requests are done
                            if (completedRequests + failedRequests === selectedListings.length) {
                                if (failedRequests === 0) {
                                    Swal.fire({
                                        title: 'Success!',
                                        text: `${completedRequests} listings deleted successfully`,
                                        icon: 'success',
                                        timer: 2000,
                                        showConfirmButton: false
                                    });
                                } else {
                                    Swal.fire({
                                        title: 'Partial Success',
                                        text: `${completedRequests} listings deleted successfully, ${failedRequests} failed`,
                                        icon: 'warning'
                                    });
                                }
                                
                                // Reload the admin data
                                loadAdminData();
                            }
                        })
                        .catch(error => {
                            failedRequests++;
                            
                            // Check if all requests are done
                            if (completedRequests + failedRequests === selectedListings.length) {
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Some or all listing deletions failed',
                                    icon: 'error'
                                });
                                
                                // Reload the admin data
                                loadAdminData();
                            }
                        });
                    });
                }
            });
        }

        // Export Functions
        function exportUsers() {
            window.location.href = '/admin/export/users';
        }

        function exportListings() {
            window.location.href = '/admin/export/listings';
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminData();
            
            // Add event listeners
            document.getElementById('userSearchBtn').addEventListener('click', searchUsers);
            document.getElementById('listingSearchBtn').addEventListener('click', searchListings);
            document.getElementById('userPrevPage').addEventListener('click', userPrevPage);
            document.getElementById('userNextPage').addEventListener('click', userNextPage);
            document.getElementById('listingPrevPage').addEventListener('click', listingPrevPage);
            document.getElementById('listingNextPage').addEventListener('click', listingNextPage);
            document.getElementById('bulkDeleteUsersBtn').addEventListener('click', bulkDeleteUsers);
            document.getElementById('bulkDeleteListingsBtn').addEventListener('click', bulkDeleteListings);
            document.getElementById('exportUsersBtn').addEventListener('click', exportUsers);
            document.getElementById('exportListingsBtn').addEventListener('click', exportListings);
            if (localStorage.getItem('isAdmin') === 'true') {
                showAdminDashboard();
            }
            
            // Initialize tooltips and popovers
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
            popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl);
            });
        });
        // Admin Functions
        

// Utility function for alerts

// Other admin functions (delete, toggle, etc.) remain the same as previous implementation

        // Initialize Admin Dashboard
        async function initAdminDashboard() {
            if (!currentUser || !currentUser.is_admin) {
                console.error('Unauthorized access to admin dashboard');
                return;
            }

            try {
                showLoading();
                const response = await fetch('/admin/dashboard', {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) throw new Error('Failed to load admin dashboard data');
                
                const data = await response.json();
                
                // Update dashboard stats
                document.getElementById('totalUsers').textContent = data.stats.total_users;
                document.getElementById('verifiedUsers').textContent = data.stats.verified_users;
                document.getElementById('unverifiedUsers').textContent = data.stats.total_users - data.stats.verified_users;
                document.getElementById('totalListings').textContent = data.stats.total_listings;
                document.getElementById('fakeWarnings').textContent = data.stats.fake_warnings;
                document.getElementById('reportsBadge').textContent = data.stats.pending_reports;
                document.getElementById('pendingReports').textContent = data.stats.pending_reports;
                
                // Populate reports table
                populateReportsTable(data.reports);
                
            } catch (error) {
                console.error('Error initializing admin dashboard:', error);
                showAlert('Error', error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Populate Reports Table
        function populateReportsTable(reports) {
            const tableBody = document.getElementById('reportsTableBody');
            if (!tableBody) {
                console.error('Reports table body element not found!');
                return;
            }
            
            tableBody.innerHTML = '';
            
            if (!reports || reports.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-3">No reports found</td>
                    </tr>
                `;
                return;
            }
            
            console.log('Populating reports table with:', reports);
            
            reports.forEach(report => {
                const row = document.createElement('tr');
                
                // Create status badge with appropriate color
                let statusBadge = '';
                if (report.status === 'pending') {
                    statusBadge = '<span class="badge bg-warning">Pending</span>';
                } else if (report.status === 'reviewed') {
                    statusBadge = '<span class="badge bg-primary">Reviewed</span>';
                } else if (report.status === 'resolved') {
                    statusBadge = '<span class="badge bg-success">Resolved</span>';
                }
                
                // Format date
                let formattedDate = 'N/A';
                if (report.created_at) {
                    const reportDate = new Date(report.created_at);
                    formattedDate = reportDate.toLocaleDateString() + ' ' + 
                                    reportDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
                
                // Description truncation
                const shortDescription = report.description ? 
                    (report.description.length > 50 ? report.description.substring(0, 47) + '...' : report.description) : 
                    'No description';
                
                row.innerHTML = `
                    <td>${report.id}</td>
                    <td>${report.listing_title || 'User Report'}</td>
                    <td>${report.reporter_name || 'Unknown'}</td>
                    <td>${shortDescription}</td>
                    <td>${statusBadge}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-report-btn" data-report-id="${report.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to the view buttons
            document.querySelectorAll('.view-report-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const reportId = this.getAttribute('data-report-id');
                    if (reportId) {
                        viewReportDetails(reportId);
                    }
                });
            });
        }

        // View Report Details
        async function viewReportDetails(reportId) {
            try {
                Swal.fire({
                    title: 'Loading...',
                    text: 'Fetching report details',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                const response = await fetch(`/admin/reports/${reportId}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load report details');
                }
                
                const report = await response.json();
                Swal.close();
                
                // Format date
                const reportDate = new Date(report.created_at);
                const formattedDate = reportDate.toLocaleDateString() + ' ' + 
                                    reportDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Create status badge with appropriate color
                let statusBadge = '';
                if (report.status === 'pending') {
                    statusBadge = '<span class="badge bg-warning">Pending</span>';
                } else if (report.status === 'reviewed') {
                    statusBadge = '<span class="badge bg-primary">Reviewed</span>';
                } else if (report.status === 'resolved') {
                    statusBadge = '<span class="badge bg-success">Resolved</span>';
                }
                
                // Populate modal content
                const modalContent = document.getElementById('reportDetailsContent');
                modalContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Report Information</h6>
                            <ul class="list-group mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Status
                                    ${statusBadge}
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Reported On
                                    <span>${formattedDate}</span>
                                </li>
                                <li class="list-group-item">
                                    <strong>Description:</strong>
                                    <p class="mt-2">${report.description}</p>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Reporter Information</h6>
                            <ul class="list-group mb-3">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Name
                                    <span>${report.reporter.name || 'N/A'}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Email
                                    <span>${report.reporter.email || 'N/A'}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    College
                                    <span>${report.reporter.college || 'N/A'}</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Reported Person Information</h6>
                            <ul class="list-group mb-3">
                                ${report.listing ? `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Name
                                        <span>${report.listing.seller.name}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Email
                                        <span>${report.listing.seller.email}</span>
                                    </li>
                                    <li class="list-group-item">
                                        <strong>Related Listing:</strong>
                                        <p class="mt-2">${report.listing.title}</p>
                                    </li>
                                ` : report.message_thread ? `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Sender
                                        <span>${report.message_thread.sender.name}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Receiver
                                        <span>${report.message_thread.receiver.name}</span>
                                    </li>
                                    <li class="list-group-item">
                                        <strong>Message Content:</strong>
                                        <p class="mt-2">${report.message_thread.content}</p>
                                    </li>
                                ` : `
                                    <li class="list-group-item">
                                        <div class="alert alert-warning mb-0">
                                            No specific person information available
                                        </div>
                                    </li>
                                `}
                            </ul>
                        </div>
                    </div>
                    
                    ${report.image_url ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Evidence Image</h6>
                            <img src="/static/${report.image_url}" class="img-fluid rounded" style="max-height: 300px;" alt="Report Evidence">
                        </div>
                    </div>
                    ` : ''}
                `;

                // Store the current report ID for action buttons
                document.getElementById('resolveReportBtn').setAttribute('data-report-id', report.id);
                document.getElementById('reviewReportBtn').setAttribute('data-report-id', report.id);

                // Show the modal
                const reportModal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));
                reportModal.show();

            } catch (error) {
                console.error('Error viewing report details:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to load report details',
                    icon: 'error'
                });
            }
        }

        // Function to update admin dashboard stats
        async function updateAdminDashboardStats() {
            try {
                const response = await fetch('/admin/dashboard', {
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch dashboard data');
                }

                const data = await response.json();

                // Update stats
                document.getElementById('totalUsers').textContent = data.stats.total_users;
                document.getElementById('verifiedUsers').textContent = data.stats.verified_users;
                document.getElementById('totalListings').textContent = data.stats.total_listings;
                document.getElementById('fakeWarnings').textContent = data.stats.fake_warnings;
                document.getElementById('pendingReports').textContent = data.stats.pending_reports;

                // Update last 30 days stats
                document.getElementById('newUsers30Days').textContent = `Last 30 days: ${data.stats.new_users_30_days || 0}`;
                document.getElementById('unverifiedCount').textContent = `Unverified: ${data.stats.total_users - data.stats.verified_users}`;
                document.getElementById('newListings30Days').textContent = `Last 30 days: ${data.stats.new_listings_30_days || 0}`;
                document.getElementById('pendingWarnings').textContent = `Pending: ${data.stats.pending_warnings || 0}`;

            } catch (error) {
                console.error('Error updating dashboard stats:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to update dashboard statistics',
                    icon: 'error'
                });
            }
        }

        // Call updateAdminDashboardStats when the dashboard is shown
        document.getElementById('dashboard-tab').addEventListener('shown.bs.tab', function (e) {
            updateAdminDashboardStats();
        });

        // Initial update when page loads if we're on the dashboard tab
        if (document.getElementById('dashboard-tab').classList.contains('active')) {
            updateAdminDashboardStats();
        }

        // Report filter
        document.getElementById('reportFilter').addEventListener('change', function() {
            const filterValue = this.value;
            const reportRows = document.querySelectorAll('#reportsTableBody tr');
            
            reportRows.forEach(row => {
                const statusCell = row.querySelector('td:nth-child(5)');
                if (!statusCell) return;
                
                const statusText = statusCell.textContent.toLowerCase();
                
                if (filterValue === '' || statusText.includes(filterValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Add a function to open the reports tab directly
        function openAdminReportsTab() {
            // First open the admin dashboard
            showAdminDashboard();
            
            // Then click on the reports tab
            setTimeout(() => {
                document.getElementById('reports-tab').click();
            }, 500);
        }
        
        // Modify showAdminDashboard to accept a tab parameter
        function showAdminDashboard(tabToShow = null) {
            // Stricter admin check - require both localStorage AND current user to be admin
            // This prevents non-admin users from accessing admin features
            if (!currentUser || !currentUser.is_admin) {
                // Clear any admin status in localStorage to be safe
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('adminDashboardOpen');
                showAlert('Access Denied', 'You must be an admin to access this page', 'error');
                return;
            }

            // Mark dashboard as open in localStorage
            localStorage.setItem('adminDashboardOpen', 'true');
            
            const adminModal = new bootstrap.Modal(document.getElementById('adminDashboardModal'));
            adminModal.show();
            loadAdminData();
            
            // Switch to specified tab if provided
            if (tabToShow) {
                setTimeout(() => {
                    document.getElementById(`${tabToShow}-tab`).click();
                }, 500);
            }
            
            // Store admin status in localStorage
            localStorage.setItem('isAdmin', 'true');
            
            // Add event listener to clear dashboard open state when closed
            const adminModalEl = document.getElementById('adminDashboardModal');
            adminModalEl.addEventListener('hidden.bs.modal', function() {
                localStorage.removeItem('adminDashboardOpen');
                console.log("Admin dashboard closed, removed from localStorage");
            });
        }

        // Add event listeners for report action buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('resolveReportBtn').addEventListener('click', function() {
                const reportId = this.getAttribute('data-report-id');
                if (reportId) {
                    updateReportStatus(reportId, 'resolved');
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: 'Could not find report ID',
                        icon: 'error'
                    });
                }
            });

            document.getElementById('reviewReportBtn').addEventListener('click', function() {
                const reportId = this.getAttribute('data-report-id');
                if (reportId) {
                    updateReportStatus(reportId, 'reviewed');
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: 'Could not find report ID',
                        icon: 'error'
                    });
                }
            });
        });

        // Update report status function
        async function updateReportStatus(reportId, status) {
            try {
                const response = await fetch(`/admin/reports/${reportId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update report status');
                }
                
                const result = await response.json();
                
                Swal.fire({
                    title: 'Success',
                    text: `Report has been marked as ${status}`,
                    icon: 'success'
                }).then(() => {
                    $('#reportDetailModal').modal('hide');
                    loadReports(); // Refresh the reports list
                });
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'An error occurred while updating the report',
                    icon: 'error'
                });
            }
        }

        // Report filter
        // ... existing code ...
        
        // Load reports function
        async function loadReports() {
            try {
                const response = await fetch('/admin/reports');
                
                if (!response.ok) {
                    throw new Error('Failed to load reports');
                }
                
                const reports = await response.json();
                const reportsContainer = document.getElementById('reportsContainer');
                
                // Clear existing reports
                reportsContainer.innerHTML = '';
                
                if (reports.length === 0) {
                    reportsContainer.innerHTML = '<div class="text-center p-4"><p>No reports found</p></div>';
                    return;
                }
                
                // Create report cards
                reports.forEach(report => {
                    const statusClass = getStatusClass(report.status);
                    const card = document.createElement('div');
                    card.className = 'card mb-3';
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title">${report.title || 'Untitled Report'}</h5>
                                <span class="badge ${statusClass}">${report.status}</span>
                            </div>
                            <p class="card-text text-muted mb-2">Reported by: ${report.reportedBy || 'Anonymous'}</p>
                            <p class="card-text mb-3">${report.description.substring(0, 100)}${report.description.length > 100 ? '...' : ''}</p>
                            <button class="btn btn-primary btn-sm view-report-btn" data-report-id="${report.id}">View Details</button>
                        </div>
                    `;
                    reportsContainer.appendChild(card);
                });
                
                // Add event listeners to view detail buttons
                document.querySelectorAll('.view-report-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const reportId = this.getAttribute('data-report-id');
                        if (reportId) {
                            showReportDetails(reportId);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading reports:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to load reports',
                    icon: 'error'
                });
            }
        }
        
        // Helper function to get status class
        function getStatusClass(status) {
            switch(status.toLowerCase()) {
                case 'pending':
                    return 'bg-warning text-dark';
                case 'resolved':
                    return 'bg-success';
                case 'reviewed':
                    return 'bg-info text-dark';
                default:
                    return 'bg-secondary';
            }
        }
        
        // Show report details function
        async function showReportDetails(reportId) {
            try {
                const response = await fetch(`/admin/reports/${reportId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load report details');
                }
                
                const report = await response.json();
                
                // Create status options
                const statusOptions = ['Pending', 'Reviewed', 'Resolved']
                    .map(status => `<option value="${status.toLowerCase()}" ${report.status.toLowerCase() === status.toLowerCase() ? 'selected' : ''}>${status}</option>`)
                    .join('');
                
                // Show modal with report details
                Swal.fire({
                    title: report.title || 'Report Details',
                    html: `
                        <div class="text-start">
                            <p><strong>Reported by:</strong> ${report.reportedBy || 'Anonymous'}</p>
                            <p><strong>Date:</strong> ${new Date(report.createdAt).toLocaleString()}</p>
                            <p><strong>Description:</strong></p>
                            <div class="border p-2 mb-3 rounded bg-light">
                                ${report.description}
                            </div>
                            <div class="form-group mb-3">
                                <label for="reportStatus" class="form-label">Status:</label>
                                <select id="reportStatus" class="form-select">
                                    ${statusOptions}
                                </select>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Update Status',
                    cancelButtonText: 'Close',
                    width: '600px'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const newStatus = document.getElementById('reportStatus').value;
                        updateReportStatus(reportId, newStatus);
                    }
                });
            } catch (error) {
                console.error('Error loading report details:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to load report details',
                    icon: 'error'
                });
            }
        }

        // Add this immediately after the report button
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener directly to the report button
            const reportBtn = document.querySelector('.chat-header button.btn-outline-danger');
            if (reportBtn) {
                reportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Report button clicked');
                    const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
                    reportModal.show();
                });
            }
        });
        
        function showReportModal() {
            console.log("Opening report modal");
            
            // Get current conversation info
            const otherUserId = currentOtherUserId;
            const listingId = currentListingId; 
            
            console.log("Report modal: listing ID =", listingId, "thread ID =", currentMessageThreadId);
            
            // If we don't have a message thread ID, create a temporary one
            if (!currentMessageThreadId) {
                currentMessageThreadId = `temp_${Date.now()}`;
                console.log("Created temporary message thread ID:", currentMessageThreadId);
            }
            
            // Update hidden fields
            document.getElementById('reportListingId').value = listingId || '';
            document.getElementById('reportMessageThreadId').value = currentMessageThreadId;
            
            // Show modal using Bootstrap
            const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            reportModal.show();
        }

        function closeReportModal() {
            const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
            if (reportModal) {
                reportModal.hide();
            }
        }

        // Add function to log download attempts
        function handleDownload(listingId, title, event) {
            console.log(`Download initiated for listing #${listingId}: ${title}`);
            
            // If not authenticated, prevent default and show login message
            if (!currentUser) {
                event.preventDefault();
                showAlert('Please Login', 'You need to login to download files', 'warning');
                return false;
            }
            
            // Show loading indicator
            const downloadBtn = event.currentTarget;
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Downloading...';
            downloadBtn.disabled = true;
            
            // Set a timer to restore the button if download doesn't start
            setTimeout(() => {
                if (downloadBtn.innerHTML.includes('Downloading')) {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }
            }, 5000);
            
            // Set up error handling for the download
            window.addEventListener('error', function(e) {
                if (e.target.tagName === 'A' && e.target === downloadBtn) {
                    showAlert('Download Failed', 'The file could not be downloaded. Please try again later.', 'error');
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.disabled = false;
                }
            }, {once: true});
            
            return true;
        }
        // Add this at the beginning of your JavaScript code
        function forceDesktopView() {
            // Set viewport to a fixed width (like desktop)
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            if (viewportMeta) {
                viewportMeta.content = "width=1200, initial-scale=1.0";
            } else {
                const meta = document.createElement('meta');
                meta.name = "viewport";
                meta.content = "width=1200, initial-scale=1.0";
                document.head.appendChild(meta);
            }
            
            // Prevent any responsive behavior
            document.documentElement.style.overflowX = "auto";
            document.body.style.minWidth = "1200px";
            document.body.style.overflowX = "auto";
            
            // Disable Bootstrap's mobile breakpoints
            const style = document.createElement('style');
            style.innerHTML = `
                @media (max-width: 1200px) {
                    .container, .container-sm, .container-md, .container-lg, .container-xl, .container-xxl {
                        max-width: 1200px;
                    }
                    .navbar-expand-lg .navbar-collapse {
                        display: flex !important;
                    }
                    .navbar-toggler {
                        display: none !important;
                    }
                }
            `;
            document.head.appendChild(style);
        }

       </script>
</body>
</html>